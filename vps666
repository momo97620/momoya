#!/bin/bash

# å®šä¹‰é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
LIGHTBLUE='\033[1;34m'
LIGHTCYAN='\033[1;36m'
NC='\033[0m' # No Color

# å®šä¹‰ç¬¦å·é“¾æ¥çš„ç›®æ ‡å’Œé“¾æ¥åç§°
LINK_NAME="/usr/local/bin/m"
SCRIPT_PATH="/root/vps666"

# æ£€æŸ¥ç¬¦å·é“¾æ¥æ˜¯å¦å·²ç»å­˜åœ¨
if [ ! -L "$LINK_NAME" ]; then
    ln -s "$SCRIPT_PATH" "$LINK_NAME"
    echo -e "${GREEN}ç¬¦å·é“¾æ¥ $LINK_NAME å·²åˆ›å»ºã€‚${NC}"
else
    echo -e "${YELLOW}ç¬¦å·é“¾æ¥ $LINK_NAME å·²å­˜åœ¨ã€‚${NC}"
fi

# è·å–è„šæœ¬è·¯å¾„
SCRIPT_PATH=$(realpath "${BASH_SOURCE[0]}")
SCRIPT_DIR=$(dirname "$SCRIPT_PATH")

# å®šä¹‰å›ºå®šå®‰è£…è·¯å¾„
# INSTALL_DIR="/usr/local/my_script"

# æ£€æŸ¥è„šæœ¬æ˜¯å¦è¢«ç›´æ¥è¿è¡Œ
if [[ "${BASH_SOURCE[0]}" != "${0}" ]]; then
    echo -e "${RED}æ­¤è„šæœ¬å¿…é¡»ç›´æ¥è¿è¡Œï¼Œè€Œä¸æ˜¯è¢«å¼•ç”¨ã€‚${NC}"
    exit 1
fi

# æ£€æŸ¥æ˜¯å¦ä»¥ root ç”¨æˆ·è¿è¡Œ
if [ "$(id -u)" != "0" ]; then
    echo -e "${RED}è¯·ä»¥ root ç”¨æˆ·è¿è¡Œè„šæœ¬ã€‚${NC}"
    exit 1
fi

# å®‰è£…ä¸»è„šæœ¬
install_script() {
    echo -e "${YELLOW}æ­£åœ¨å®‰è£…ï¼šå°†è„šæœ¬å®‰è£…åˆ° $INSTALL_DIR...${NC}"
    
    if [ ! -d "$INSTALL_DIR" ]; then
        mkdir -p "$INSTALL_DIR"
    fi
    
    cp "$SCRIPT_PATH" "$INSTALL_DIR"
    chmod +x "$INSTALL_DIR/$(basename "$SCRIPT_PATH")"
    
    echo -e "${GREEN}è„šæœ¬å·²å®‰è£…åˆ° $INSTALL_DIRã€‚${NC}"
}

# æ‰§è¡Œå­è„šæœ¬
execute_script() {
    local script_url="$1"
    local success_message="$2"
    
    bash <(curl -sSL "$script_url")
    echo -e "${GREEN}$success_message${NC}"
    
    read -p "æŒ‰ä»»æ„é”®è¿”å›ä¸»èœå•..."
}

# å®šä¹‰ configure_ssh_pam å‡½æ•°
configure_ssh_pam() {
    # æ£€æŸ¥æ˜¯å¦ä»¥ root æƒé™è¿è¡Œ
    if [[ $EUID -ne 0 ]]; then
        echo -e "\033[0;31m[é”™è¯¯] è¯·ä»¥ root æƒé™è¿è¡Œæ­¤è„šæœ¬ã€‚\033[0m"
        exit 1
    fi

    # è®¾ç½®å˜é‡
    local SSHD_CONFIG="/etc/ssh/sshd_config"
    local COMMON_AUTH="/etc/pam.d/common-auth"
    local SSH_KEY_DIR="$HOME/.ssh"
    local SSH_KEY_FILE="$SSH_KEY_DIR/id_rsa"
    local AUTHORIZED_KEYS="$SSH_KEY_DIR/authorized_keys"

    # æ‰“å°ç•Œé¢ä¿¡æ¯
    print_banner() {
        echo -e "\033[1;32m=======================================\033[0m"
        echo -e "\033[1;32m   SSH å’Œ PAM é…ç½®è‡ªåŠ¨åŒ–è„šæœ¬ï¼ˆå¢å¼ºç‰ˆï¼‰   \033[0m"
        echo -e "\033[1;32m=======================================\033[0m"
    }

    # ç¦ç”¨ UsePAM
    disable_use_pam() {
        echo -e "\033[1;34mæ­£åœ¨ç¦ç”¨ UsePAM...\033[0m"
        if grep -q "^UsePAM" "$SSHD_CONFIG"; then
            sed -i.bak '/^UsePAM/c\UsePAM no' "$SSHD_CONFIG"
            echo -e "\033[1;32må·²å°† UsePAM è®¾ç½®ä¸º noã€‚\033[0m"
        else
            echo "UsePAM no" >> "$SSHD_CONFIG"
            echo -e "\033[1;32må·²æ·»åŠ  UsePAM noã€‚\033[0m"
        fi
    }

    # æ³¨é‡Šæ‰æŒ‡å®šçš„è¡Œ
    comment_out_lines() {
        echo -e "\033[1;34mæ­£åœ¨æ³¨é‡Šæ‰ PAM æ¨¡å—æŒ‡å®šè¡Œ...\033[0m"
        sed -i.bak '/^# here are the per-package modules (the "Primary" block)/s/^/# /' "$COMMON_AUTH"
        sed -i '/^auth\s\+\[success=1 default=ignore\]\s\+pam_unix.so nullok/s/^/# /' "$COMMON_AUTH"

        if grep -q "^# auth\s\+\[success=1 default=ignore\]\s\+pam_unix.so nullok" "$COMMON_AUTH"; then
            echo -e "\033[1;32må·²æˆåŠŸæ³¨é‡ŠæŒ‡å®šçš„è¡Œã€‚\033[0m"
        else
            echo -e "\033[0;31m[è­¦å‘Š] æœªæˆåŠŸæ³¨é‡ŠæŒ‡å®šçš„è¡Œï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥ã€‚\033[0m"
        fi
    }

    # ç¦ç”¨å¯†ç ç™»å½•ï¼ˆé…ç½®ä¸ä¼šç«‹å³ç”Ÿæ•ˆï¼Œéœ€é‡å¯ SSH æœåŠ¡ï¼‰
    disable_password_auth() {
        echo -e "\033[1;34mæ­£åœ¨ç¦ç”¨å¯†ç ç™»å½•...\033[0m"
        if grep -q "^PasswordAuthentication" "$SSHD_CONFIG"; then
            sed -i '/^PasswordAuthentication/c\PasswordAuthentication no' "$SSHD_CONFIG"
            echo -e "\033[1;32må·²å°† PasswordAuthentication è®¾ç½®ä¸º noã€‚\033[0m"
        else
            echo "PasswordAuthentication no" >> "$SSHD_CONFIG"
            echo -e "\033[1;32må·²æ·»åŠ  PasswordAuthentication noã€‚\033[0m"
        fi
        echo -e "\033[1;31mæ³¨æ„ï¼šç¦ç”¨å¯†ç ç™»å½•çš„é…ç½®å°†åœ¨é‡å¯ SSH æœåŠ¡åç”Ÿæ•ˆï¼\033[0m"
    }

    # è‡ªåŠ¨ç”Ÿæˆ SSH å¯†é’¥å¹¶æ·»åŠ åˆ°æœ¬æœº
    generate_ssh_key() {
        echo -e "\033[1;34mæ­£åœ¨æ£€æŸ¥æˆ–ç”Ÿæˆ SSH å¯†é’¥å¯¹...\033[0m"
        if [[ ! -f "$SSH_KEY_FILE" ]]; then
            mkdir -p "$SSH_KEY_DIR"
            chmod 700 "$SSH_KEY_DIR"
            ssh-keygen -t rsa -b 4096 -f "$SSH_KEY_FILE" -N "" >/dev/null
            echo -e "\033[1;32må·²æˆåŠŸç”Ÿæˆ SSH å¯†é’¥å¯¹ã€‚\033[0m"
            echo -e "\033[1;32mç§é’¥æ–‡ä»¶ï¼š$SSH_KEY_FILE\033[0m"
            echo -e "\033[1;32må…¬é’¥æ–‡ä»¶ï¼š$SSH_KEY_FILE.pub\033[0m"

            # å°†å…¬é’¥æ·»åŠ åˆ° authorized_keys
            if [[ ! -f "$AUTHORIZED_KEYS" ]]; then
                touch "$AUTHORIZED_KEYS"
                chmod 600 "$AUTHORIZED_KEYS"
            fi

            cat "$SSH_KEY_FILE.pub" >> "$AUTHORIZED_KEYS"
            echo -e "\033[1;32må·²å°†å…¬é’¥æ·»åŠ åˆ°æœ¬æœºçš„ authorized_keys æ–‡ä»¶ã€‚\033[0m"
        else
            echo -e "\033[1;32mSSH å¯†é’¥å·²å­˜åœ¨ï¼Œè·³è¿‡ç”Ÿæˆæ­¥éª¤ã€‚\033[0m"
            echo -e "\033[1;32mç§é’¥æ–‡ä»¶ï¼š$SSH_KEY_FILE\033[0m"
            echo -e "\033[1;32må…¬é’¥æ–‡ä»¶ï¼š$SSH_KEY_FILE.pub\033[0m"
        fi
    }

    # æç¤ºç”¨æˆ·æ‰‹åŠ¨é‡å¯ SSH æœåŠ¡
    prompt_manual_restart() {
        echo -e "\033[1;34mè¯·æ‰‹åŠ¨é‡å¯ SSH æœåŠ¡ï¼Œä»¥åº”ç”¨æ›´æ”¹ï¼š\033[0m"
        echo -e "\033[1;32må‘½ä»¤ï¼šsystemctl restart sshd\033[0m"
    }

    # ä¸»è„šæœ¬é€»è¾‘
    main() {
        print_banner
        disable_use_pam          # ç¦ç”¨ UsePAM
        comment_out_lines        # æ³¨é‡Šæ‰ PAM æ¨¡å—æŒ‡å®šè¡Œ
        disable_password_auth    # ç¦ç”¨å¯†ç ç™»å½•ï¼ˆé…ç½®ä¸ä¼šç«‹å³ç”Ÿæ•ˆï¼‰
        generate_ssh_key         # è‡ªåŠ¨ç”Ÿæˆ SSH å¯†é’¥å¯¹å¹¶æ·»åŠ åˆ°æœ¬æœº
        prompt_manual_restart    # æç¤ºç”¨æˆ·æ‰‹åŠ¨é‡å¯ SSH æœåŠ¡
        echo -e "\033[1;32mé…ç½®å®Œæˆï¼\033[0m"
    }

    # æ‰§è¡Œä¸»é€»è¾‘
    main

    # è¿”å›æç¤º
    echo -e "\033[1;34mæŒ‰ä»»æ„é”®é€€å‡ºè„šæœ¬...\033[0m"
    read -n 1 -s
}

# è®¾ç½® IPv4/6 ä¼˜å…ˆçº§
set_ip_priority() {
    check_current_priority() {
        if grep -q "net.ipv6.conf.all.disable_ipv6 = 1" /etc/sysctl.conf; then
            echo "å½“å‰ä¼˜å…ˆçº§ï¼šIPv4"
        else
            echo "å½“å‰ä¼˜å…ˆçº§ï¼šIPv6"
        fi
    }

    set_priority() {
        case "$1" in
            1)
                echo "æ­£åœ¨è®¾ç½®ä¼˜å…ˆä½¿ç”¨ IPv4..."
                echo "net.ipv6.conf.all.disable_ipv6 = 1" >> /etc/sysctl.conf
                echo "net.ipv6.conf.default.disable_ipv6 = 1" >> /etc/sysctl.conf
                sysctl -p
                echo "IPv4 ä¼˜å…ˆè®¾ç½®å®Œæˆï¼"
                ;;
            2)
                echo "æ­£åœ¨è®¾ç½®ä¼˜å…ˆä½¿ç”¨ IPv6..."
                sed -i '/net.ipv6.conf.all.disable_ipv6/d' /etc/sysctl.conf
                sed -i '/net.ipv6.conf.default.disable_ipv6/d' /etc/sysctl.conf
                echo "net.ipv6.conf.all.disable_ipv6 = 0" >> /etc/sysctl.conf
                echo "net.ipv6.conf.default.disable_ipv6 = 0" >> /etc/sysctl.conf
                sysctl -p
                echo "IPv6 ä¼˜å…ˆè®¾ç½®å®Œæˆï¼"
                ;;
            *)
                echo "æ— æ•ˆçš„é€‰é¡¹ï¼è¯·è¾“å…¥ '1' æˆ– '2'ã€‚"
                exit 1
                ;;
        esac
    }

    show_menu() {
        clear
        echo "==============================="
        echo " è®¾ç½® IPv4 æˆ– IPv6 ä¼˜å…ˆçº§"
        echo "==============================="
        check_current_priority
        echo "1. ä¼˜å…ˆä½¿ç”¨ IPv4"
        echo "2. ä¼˜å…ˆä½¿ç”¨ IPv6"
        echo "==============================="
        read -p "è¯·è¾“å…¥é€‰é¡¹ [1/2]ï¼š" choice
        set_priority "$choice"
        echo "è®¾ç½®å®Œæˆï¼æŒ‰ä»»æ„é”®é€€å‡º..."
        read -n 1 -s -r
    }

    show_menu
}

# æ›´æ–°è„šæœ¬
update_script() {
    local remote_url="https://raw.githubusercontent.com/momo97620/momoya/refs/heads/main/vps666"
    local local_path="/root/vps666"

    echo -e "${YELLOW}æ­£åœ¨æ›´æ–°è„šæœ¬åˆ°æœ€æ–°ç‰ˆæœ¬...${NC}"

    if curl -sSL "$remote_url" -o "$local_path"; then
        chmod +x "$local_path"
        echo -e "${GREEN}è„šæœ¬æ›´æ–°æˆåŠŸï¼æœ€æ–°ç‰ˆæœ¬å·²ä¿å­˜åˆ° $local_pathã€‚${NC}"
    else
        echo -e "${RED}è„šæœ¬æ›´æ–°å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¿œç¨‹ URL æ˜¯å¦æ­£ç¡®ã€‚${NC}"
    fi

    read -p "æŒ‰ä»»æ„é”®è¿”å›ä¸»èœå•..."
}

set_ssh_keepalive() {
    local config_file="/etc/ssh/sshd_config"
    local interval=60
    local count=10

    echo "æ­£åœ¨é…ç½® SSH å®¢æˆ·ç«¯ä¿æŒè¿æ¥å‚æ•°..."
    if [[ ! -f "$config_file" ]]; then
        echo "é”™è¯¯ï¼šSSH é…ç½®æ–‡ä»¶ $config_file ä¸å­˜åœ¨ã€‚" >&2
        exit 1
    fi

    read -p "æ˜¯å¦ç¡®è®¤ä¿®æ”¹ SSH é…ç½®ï¼Ÿ(y/n): " confirm
    if [[ "$confirm" != "y" ]]; then
        echo "å–æ¶ˆä¿®æ”¹ã€‚"
        exit 0
    fi

    read -p "è¯·è¾“å…¥ ClientAliveInterval å€¼ï¼ˆé»˜è®¤ 60ï¼‰: " user_interval
    if [[ -n "$user_interval" ]]; then
        interval=$user_interval
    fi

    read -p "è¯·è¾“å…¥ ClientAliveCountMax å€¼ï¼ˆé»˜è®¤ 10ï¼‰: " user_count
    if [[ -n "$user_count" ]]; then
        count=$user_count
    fi

    if grep -q '^#\?ClientAliveInterval' "$config_file"; then
        sed -ri "s/^#?.*ClientAliveInterval.*/ClientAliveInterval $interval/" "$config_file"
    else
        echo "ClientAliveInterval $interval" >> "$config_file"
    fi

    if grep -q '^#\?ClientAliveCountMax' "$config_file"; then
        sed -ri "s/^#?.*ClientAliveCountMax.*/ClientAliveCountMax $count/" "$config_file"
    else
        echo "ClientAliveCountMax $count" >> "$config_file"
    fi

    echo "é‡å¯ SSH æœåŠ¡ä»¥åº”ç”¨æ›´æ”¹..."
    sudo systemctl restart sshd
    if [[ $? -eq 0 ]]; then
        echo "SSH é…ç½®å·²æ›´æ–°å¹¶æˆåŠŸåº”ç”¨ï¼"
    else
        echo "SSH æœåŠ¡é‡å¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®ã€‚" >&2
        exit 1
    fi
    echo "æŒ‰ä»»æ„é”®è¿”å›ä¸»èœå•..."
    read -n 1 -s -r
}

download_reinstall_script() {
    while true; do
        echo "è¯·é€‰æ‹©DDå¯¹åº”vpsï¼š"
        echo "1. å›½å¤–æœåŠ¡å™¨"
        echo "2. å›½å†…æœåŠ¡å™¨"
        echo "0. é€€å‡º"
        read -p "è¯·è¾“å…¥é€‰é¡¹ (0, 1 æˆ– 2): " choice

        case $choice in
            1)
                echo "ä»å›½å¤–æœåŠ¡å™¨ä¸‹è½½..."
                curl -O https://raw.githubusercontent.com/bin456789/reinstall/main/reinstall.sh || wget -O reinstall.sh https://raw.githubusercontent.com/bin456789/reinstall/main/reinstall.sh
                break
                ;;
            2)
                echo "ä»å›½å†…æœåŠ¡å™¨ä¸‹è½½..."
                curl -O https://www.ghproxy.com/https://raw.githubusercontent.com/bin456789/reinstall/main/reinstall.sh || wget -O reinstall.sh https://www.ghproxy.com/https://raw.githubusercontent.com/bin456789/reinstall/main/reinstall.sh
                break
                ;;
            0)
                echo "é€€å‡ºè„šæœ¬ã€‚"
                exit 0
                ;;
            *)
                echo "æ— æ•ˆé€‰é¡¹ï¼Œè¯·é€‰æ‹© 0, 1 æˆ– 2ã€‚"
                ;;
        esac
    done
}

run_reinstall_script() {
    while true; do
        echo -e "${GREEN}è¯·é€‰æ‹©è¦å®‰è£…çš„ç³»ç»Ÿç‰ˆæœ¬ï¼š${NC}"
        echo -e "${RED}1. Ubuntu 22.04${NC}"
        echo -e "${YELLOW}2. Ubuntu 20.04${NC}"
        echo -e "${BLUE}3. Ubuntu 24.04${NC}"
        echo -e "${MAGENTA}4. Debian 11${NC}"
        echo -e "${CYAN}5. Debian 12${NC}"
        echo -e "${GREEN}0. é€€å‡º${NC}"
        read -p "è¯·è¾“å…¥é€‰é¡¹ (0-5): " choice

        case $choice in
            1)
                bash reinstall.sh ubuntu 22.04
                break
                ;;
            2)
                bash reinstall.sh ubuntu 20.04
                break
                ;;
            3)
                bash reinstall.sh ubuntu 24.04
                break
                ;;
            4)
                bash reinstall.sh debian 11
                break
                ;;
            5)
                bash reinstall.sh debian 12
                break
                ;;
            0)
                echo "é€€å‡ºè„šæœ¬ã€‚"
                exit 0
                ;;
            *)
                echo "æ— æ•ˆé€‰é¡¹ï¼Œè¯·é€‰æ‹© 0-5ã€‚"
                ;;
        esac
    done
}


show_main_menu() {
    clear
    # å®šä¹‰é¢œè‰²
    LIGHTCYAN='\033[1;36m'  # æ˜äº®çš„é’è‰²
    NC='\033[0m'  # é‡ç½®é¢œè‰²

    # ASCII è‰ºæœ¯å±•ç¤º "EMoMoMo"
    echo -e "${LIGHTCYAN}"
    echo "  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—"
    echo "  â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—"
    echo "  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘"
    echo "  â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘"
    echo "  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•"
    echo "  â•šâ•â•â•â•â•â•â•â•šâ•â•     â•šâ•â• â•šâ•â•â•â•â•â• â•šâ•â•     â•šâ•â• â•šâ•â•â•â•â•â• â•šâ•â•     â•šâ•â• â•šâ•â•â•â•â•â• "
    echo -e "${NC}"

    echo -e "${LIGHTCYAN}============================= VPS è„šæœ¬èœå• =============================${NC}"
    echo -e "${LIGHTBLUE}ä½¿ç”¨å¿«æ·æŒ‡ä»¤ m å¯å¿«é€Ÿæ‰“å¼€è„šæœ¬ğŸ˜Š${NC}"
    echo -e "${LIGHTBLUE}ä½œè€…ï¼šemoçš„å°é»˜é»˜${NC}"
    echo -e "${LIGHTCYAN}=====================================================================${NC}"
    
    echo -e "${YELLOW}è¯·é€‰æ‹©è¦æ‰§è¡Œçš„ä»»åŠ¡ï¼š${NC}"

    # ä½¿ç”¨ printf æ ¼å¼åŒ–èœå•é€‰é¡¹ï¼Œç¡®ä¿å¯¹é½
    printf "${GREEN}%-3s %-30s${NC}\n" "1." "æ­å»ºhy2èŠ‚ç‚¹"
    printf "${GREEN}%-3s %-30s${NC}\n" "2." "UFW é˜²ç«å¢™"
    printf "${GREEN}%-3s %-30s${NC}\n" "3." "é…ç½®å¯†é’¥ç™»å½•"
    printf "${GREEN}%-3s %-30s${NC}\n" "4." "ä¿®æ”¹ç™»å½•ç«¯å£"
    printf "${GREEN}%-3s %-30s${NC}\n" "5." "ä¸€é”®æ­å»ºèŠ‚ç‚¹"
    printf "${GREEN}%-3s %-30s${NC}\n" "6." "ä¸€é”®WARP"
    printf "${GREEN}%-3s %-30s${NC}\n" "7." "BBRåŠ é€Ÿ"
    printf "${GREEN}%-3s %-30s${NC}\n" "8." "Dockerç®¡ç†"
    printf "${GREEN}%-3s %-30s${NC}\n" "9." "ç³»ç»Ÿä¿¡æ¯æŸ¥è¯¢"
    printf "${GREEN}%-3s %-30s${NC}\n" "10." "è®¾IPv4/6ä¼˜å…ˆçº§"
    printf "${GREEN}%-3s %-30s${NC}\n" "11." "æ›´æ–°è„šæœ¬"
    printf "${GREEN}%-3s %-30s${NC}\n" "12." "ä¿æŒsshé“¾æ¥"
    printf "${GREEN}%-3s %-30s${NC}\n" "13." "DDç³»ç»Ÿ"
    printf "${GREEN}%-3s %-30s${NC}\n" "14." "TGå…³é”®è¯è®¢é˜…"
    printf "${GREEN}%-3s %-30s${NC}\n" "15." "æµé‡ç»Ÿè®¡"
    printf "${GREEN}%-3s %-30s${NC}\n" "0." "é€€å‡º"
    echo -e "${LIGHTCYAN}=====================================================================${NC}"
    read -p "è¯·è¾“å…¥é€‰é¡¹ (0-15): " choice
    case $choice in
        1)
            execute_script "https://gist.githubusercontent.com/momo97620/68630501ec62d5f6ece848d5e3ffad4e/raw/203246731cde7f6ca90d8b2e934cf0ffa5127cb4/hy2" "æ­å»º Hysteria èŠ‚ç‚¹å®Œæˆã€‚"
            ;;
        2)
            execute_script "https://gist.githubusercontent.com/momo97620/2ecbf06ce959fda14b01c0ce9f34f3d8/raw/ebbbdf08a05c890d72902863c53bf80af9531601/ufw_install.sh" "å®‰è£…å¹¶é…ç½® UFW é˜²ç«å¢™å®Œæˆã€‚"
            ;;
        3)
            configure_ssh_pam
            ;;
        4)
            execute_script "https://gist.githubusercontent.com/momo97620/685e1ead90ed0ad379c6a75e27409704/raw/aaeabe347f3612e9c308b898e64bcfd12276a067/duank" "ä¿®æ”¹ç™»å½•ç«¯å£å·å®Œæˆã€‚"
            ;;
        5)
            execute_script "https://github.com/233boy/sing-box/raw/main/install.sh" "ä¸€é”®æ­å»ºèŠ‚ç‚¹å®Œæˆã€‚"
            ;;
        6)
            execute_script "https://gitlab.com/fscarmen/warp/-/raw/main/menu.sh" "ä¸€é”®WARPå®Œæˆã€‚"
            ;;
        7)
            execute_script "https://github.com/ylx2016/Linux-NetSpeed/raw/master/tcp.sh" "BBRåŠ é€Ÿå®Œæˆã€‚"
            ;;
        8)
            execute_script "https://raw.githubusercontent.com/momo97620/momoya/refs/heads/main/docker" "Dockerç®¡ç†å®Œæˆã€‚"
            ;;
        9)
            execute_script "https://raw.githubusercontent.com/momo97620/momoya/main/xitong" "ç³»ç»Ÿä¿¡æ¯æŸ¥è¯¢å®Œæˆã€‚"
            ;;
        10)
            set_ip_priority
            ;;
        11)
            update_script
            ;;
        12) 
            set_ssh_keepalive
            ;;
        13) 
            download_reinstall_script
            run_reinstall_script
            ;;  
        14) 
             execute_script "curl -sS -O https://raw.githubusercontent.com/ecouus/Feed-Push/refs/heads/main/bot_deploy.sh && sudo chmod +x bot_deploy.sh && ./bot_deploy.sh "
            ;;  
        15) 
            network_traffic_monitor
            ;;  
        0)
            echo -e "${GREEN}é€€å‡ºç¨‹åº...${NC}"
            exit 0
            ;;
        *)
            echo -e "${RED}æ— æ•ˆçš„é€‰æ‹©ï¼Œè¯·é‡æ–°è¾“å…¥ï¼${NC}"
            read -p "æŒ‰å›è½¦é”®è¿”å›ä¸»èœå•..."
            ;;
    esac
}

# ä¸»æ‰§è¡Œé€»è¾‘
main() {
    if [[ "$1" == "install" ]]; then
        install_script
        exit 0
    fi

    echo -e "${YELLOW}è„šæœ¬è·¯å¾„: $SCRIPT_PATH${NC}"
    echo -e "${YELLOW}å®‰è£…è·¯å¾„: $INSTALL_DIR${NC}"

    if [ ! -d "$INSTALL_DIR" ]; then
        install_script
    else
        echo -e "${GREEN}è„šæœ¬å·²å®‰è£…åˆ°ï¼š$INSTALL_DIR${NC}"
    fi

    # è°ƒç”¨ä¸»èœå•
    while true; do
        show_main_menu
    done
}

# æ‰§è¡Œä¸»é€»è¾‘
main "$@"