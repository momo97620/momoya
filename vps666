#!/bin/bash

# 获取脚本路径
SCRIPT_PATH=$(realpath "${BASH_SOURCE[0]}")
SCRIPT_DIR=$(dirname "$SCRIPT_PATH")

# 定义固定安装路径（例如：/usr/local/my_script）
INSTALL_DIR="/usr/local/my_script"
SCRIPT_NAME="vps666.sh"

# 定义颜色
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
LIGHTBLUE='\033[1;34m'
LIGHTCYAN='\033[1;36m'
NC='\033[0m' # No Color

# 检查是否以 root 用户运行
if [ "$(id -u)" != "0" ]; then
    echo -e "${RED}请以 root 用户运行脚本。${NC}"
    exit 1
fi

# 设置快捷启动命令
setup_quick_command() {
    local target_script="$INSTALL_DIR/$SCRIPT_NAME"

    # 确保脚本安装路径存在
    if [ ! -f "$target_script" ]; then
        echo -e "${RED}目标脚本 $target_script 不存在，无法设置快捷命令 'n'！${NC}"
        return 1
    fi

    # 创建软链接到 /usr/local/bin/n
    if [ ! -L "/usr/local/bin/n" ]; then
        ln -sf "$target_script" /usr/local/bin/n
        chmod +x /usr/local/bin/n
        echo -e "${GREEN}快捷命令 'n' 已成功设置！现在可以直接输入 'n' 快速启动脚本。${NC}"
    else
        echo -e "${YELLOW}快捷命令 'n' 已存在，无需重复设置。${NC}"
    fi
}

# 安装主脚本
install_script() {
    echo -e "${YELLOW}正在安装：将脚本安装到 $INSTALL_DIR...${NC}"
    
    # 创建安装目录
    if [ ! -d "$INSTALL_DIR" ]; then
        mkdir -p "$INSTALL_DIR"
    fi
    
    # 将脚本复制到安装目录
    cp "$SCRIPT_PATH" "$INSTALL_DIR/$SCRIPT_NAME"
    
    # 设置执行权限
    chmod +x "$INSTALL_DIR/$SCRIPT_NAME"
    
    echo -e "${GREEN}脚本已安装到 $INSTALL_DIR。${NC}"

    # 设置快捷启动命令
    setup_quick_command
}

# 更新主脚本
update_script() {
    echo -e "${YELLOW}正在更新脚本...${NC}"
    wget -q -O "$INSTALL_DIR/$SCRIPT_NAME" "https://emoxiaomomo.9762006.xyz/vps666"
    chmod +x "$INSTALL_DIR/$SCRIPT_NAME"
    echo -e "${GREEN}脚本已成功更新！${NC}"
}

# 卸载主脚本
uninstall_script() {
    echo -e "${YELLOW}开始卸载主脚本并清除相关数据...${NC}"
    read -p "确定要卸载主脚本并清除相关数据吗？(y/n): " confirm
    if [ "$confirm" != "y" ]; then
        echo -e "${RED}卸载已取消。${NC}"
        return
    fi

    # 删除脚本文件及快捷命令
    rm -rf "$INSTALL_DIR"
    rm -f "/usr/local/bin/n"
    echo -e "${GREEN}主脚本及相关快捷命令已卸载！${NC}"
}

# 显示主菜单
show_main_menu() {
    while true; do
        clear
        echo -e "${GREEN}======================== VPS 脚本菜单 ========================${NC}"
        echo -e "${LIGHTCYAN}作者：emo的小默默${NC}"
        echo -e "${BLUE}------------------------------------------------------------${NC}"
        echo -e "${GREEN}请选择要执行的任务：${NC}"
        echo -e "1. 安装脚本"
        echo -e "2. 更新脚本"
        echo -e "3. 卸载脚本"
        echo -e "4. 搭建 Hysteria 节点"
        echo -e "5. 安装并配置 UFW 防火墙"
        echo -e "6. 一键 WARP"
        echo -e "7. BBR 加速"
        echo -e "8. Docker 管理"
        echo -e "9. 系统信息查询"
        echo -e "0. 退出"
        echo -e "${BLUE}------------------------------------------------------------${NC}"
        
        read -p "请输入选项 (0-9): " choice
        case $choice in
            1)
                install_script
                ;;
            2)
                update_script
                ;;
            3)
                uninstall_script
                ;;
            4)
                echo -e "${YELLOW}正在执行：搭建 Hysteria 节点...${NC}"
                bash <(curl -sSL https://gist.githubusercontent.com/momo97620/68630501ec62d5f6ece848d5e3ffad4e/raw/203246731cde7f6ca90d8b2e934cf0ffa5127cb4/hy2)
                ;;
            5)
                echo -e "${YELLOW}正在执行：安装并配置 UFW 防火墙...${NC}"
                bash <(curl -sSL https://gist.githubusercontent.com/momo97620/2ecbf06ce959fda14b01c0ce9f34f3d8/raw/e7d1e2ad49decc464f0a814c436ca4b6151986e7/ufw_install.sh)
                ;;
            6)
                echo -e "${YELLOW}正在执行：一键 WARP...${NC}"
                wget -N https://gitlab.com/fscarmen/warp/-/raw/main/menu.sh && bash menu.sh
                ;;
            7)
                echo -e "${YELLOW}正在执行：BBR 加速...${NC}"
                wget -O tcp.sh "https://github.com/ylx2016/Linux-NetSpeed/raw/master/tcp.sh" && chmod +x tcp.sh && ./tcp.sh
                ;;
            8)
                echo -e "${YELLOW}正在执行：Docker 管理...${NC}"
                curl -fsSL "https://raw.githubusercontent.com/momo97620/momoya/refs/heads/main/docker" -o docker_script && chmod +x docker_script && ./docker_script
                ;;
            9)
                echo -e "${YELLOW}正在执行：系统信息查询...${NC}"
                bash <(curl -sSL https://raw.githubusercontent.com/momo97620/momoya/main/xitong)
                ;;
            0)
                echo -e "${GREEN}退出程序...${NC}"
                exit 0
                ;;
            *)
                echo -e "${RED}无效的选择，请重新输入！${NC}"
                ;;
        esac
    done
}

# 检查是否安装脚本
if [ ! -d "$INSTALL_DIR" ]; then
    install_script
fi

# 显示主菜单
show_main_menu