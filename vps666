#!/bin/bash

# å®šä¹‰é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
LIGHTBLUE='\033[1;34m'
LIGHTCYAN='\033[1;36m'
BRIGHT_MAGENTA='\033[1;35m'  # äº®ç´«è‰²
WHITE='\033[1;37m'
NC='\033[0m' # No Color

# å®šä¹‰ç¬¦å·é“¾æ¥çš„ç›®æ ‡å’Œé“¾æ¥åç§°
LINK_NAME="/usr/local/bin/m"
SCRIPT_PATH="/root/vps666"

# æ£€æŸ¥ç¬¦å·é“¾æ¥æ˜¯å¦å·²ç»å­˜åœ¨
if [ ! -L "$LINK_NAME" ]; then
    ln -s "$SCRIPT_PATH" "$LINK_NAME"
    echo -e "${GREEN}ç¬¦å·é“¾æ¥ $LINK_NAME å·²åˆ›å»ºã€‚${NC}"
else
    echo -e "${YELLOW}ç¬¦å·é“¾æ¥ $LINK_NAME å·²å­˜åœ¨ã€‚${NC}"
fi

# è·å–è„šæœ¬è·¯å¾„
SCRIPT_PATH=$(realpath "${BASH_SOURCE[0]}")
SCRIPT_DIR=$(dirname "$SCRIPT_PATH")

# å®šä¹‰å›ºå®šå®‰è£…è·¯å¾„
INSTALL_DIR="/usr/local/my_script"

# æ£€æŸ¥è„šæœ¬æ˜¯å¦è¢«ç›´æ¥è¿è¡Œ
if [[ "${BASH_SOURCE[0]}" != "${0}" ]]; then
    echo -e "${RED}æ­¤è„šæœ¬å¿…é¡»ç›´æ¥è¿è¡Œï¼Œè€Œä¸æ˜¯è¢«å¼•ç”¨ã€‚${NC}"
    exit 1
fi

# æ£€æŸ¥æ˜¯å¦ä»¥ root ç”¨æˆ·è¿è¡Œ
if [ "$(id -u)" != "0" ]; then
    echo -e "${RED}è¯·ä»¥ root ç”¨æˆ·è¿è¡Œè„šæœ¬ã€‚${NC}"
    exit 1
fi

# å®‰è£…ä¸»è„šæœ¬
install_script() {
    echo -e "${YELLOW}æ­£åœ¨å®‰è£…ï¼šå°†è„šæœ¬å®‰è£…åˆ° $INSTALL_DIR...${NC}"
    
    if [ ! -d "$INSTALL_DIR" ]; then
        mkdir -p "$INSTALL_DIR"
    fi
    
    cp "$SCRIPT_PATH" "$INSTALL_DIR"
    chmod +x "$INSTALL_DIR/$(basename "$SCRIPT_PATH")"
    
    echo -e "${GREEN}è„šæœ¬å·²å®‰è£…åˆ° $INSTALL_DIRã€‚${NC}"
}

# æ‰§è¡Œå­è„šæœ¬
execute_script() {
    local script_url="$1"
    local success_message="$2"
    
    bash <(curl -sSL "$script_url")
    echo -e "${GREEN}$success_message${NC}"
    
    read -p "æŒ‰ä»»æ„é”®è¿”å›ä¸»èœå•..."
}

# è®¾ç½® IPv4/6 ä¼˜å…ˆçº§
set_ip_priority() {
    # æ£€æŸ¥å½“å‰ä¼˜å…ˆçº§
    check_current_priority() {
        if grep -q "net.ipv6.conf.all.disable_ipv6 = 1" /etc/sysctl.conf; then
            echo "å½“å‰ä¼˜å…ˆçº§ï¼šIPv4"
        else
            echo "å½“å‰ä¼˜å…ˆçº§ï¼šIPv6"
        fi
    }

    # è®¾ç½®ä¼˜å…ˆçº§
    set_priority() {
        case "$1" in
            1)
                echo "æ­£åœ¨è®¾ç½®ä¼˜å…ˆä½¿ç”¨ IPv4..."
                # ç¦ç”¨ IPv6
                echo "net.ipv6.conf.all.disable_ipv6 = 1" >> /etc/sysctl.conf
                echo "net.ipv6.conf.default.disable_ipv6 = 1" >> /etc/sysctl.conf
                # åº”ç”¨æ›´æ”¹
                sysctl -p
                echo "IPv4 ä¼˜å…ˆè®¾ç½®å®Œæˆï¼"
                ;;
            2)
                echo "æ­£åœ¨è®¾ç½®ä¼˜å…ˆä½¿ç”¨ IPv6..."
                # å¯ç”¨ IPv6
                sed -i '/net.ipv6.conf.all.disable_ipv6/d' /etc/sysctl.conf
                sed -i '/net.ipv6.conf.default.disable_ipv6/d' /etc/sysctl.conf
                echo "net.ipv6.conf.all.disable_ipv6 = 0" >> /etc/sysctl.conf
                echo "net.ipv6.conf.default.disable_ipv6 = 0" >> /etc/sysctl.conf
                # åº”ç”¨æ›´æ”¹
                sysctl -p
                echo "IPv6 ä¼˜å…ˆè®¾ç½®å®Œæˆï¼"
                ;;
            *)
                echo "æ— æ•ˆçš„é€‰é¡¹ï¼è¯·è¾“å…¥ '1' æˆ– '2'ã€‚"
                exit 1
                ;;
        esac
    }

    # ä¸»èœå•
    show_menu() {
        clear
        echo "==============================="
        echo " è®¾ç½® IPv4 æˆ– IPv6 ä¼˜å…ˆçº§"
        echo "==============================="
        check_current_priority
        echo "1. ä¼˜å…ˆä½¿ç”¨ IPv4"
        echo "2. ä¼˜å…ˆä½¿ç”¨ IPv6"
        echo "==============================="
        read -p "è¯·è¾“å…¥é€‰é¡¹ [1/2]ï¼š" choice

        # æ ¹æ®ç”¨æˆ·é€‰æ‹©è®¾ç½®ä¼˜å…ˆçº§
        set_priority "$choice"

        # æç¤ºç”¨æˆ·æŒ‰ä»»æ„é”®é€€å‡º
        echo "è®¾ç½®å®Œæˆï¼æŒ‰ä»»æ„é”®é€€å‡º..."
        read -n 1 -s -r
    }

    # è¿è¡Œä¸»èœå•
    show_menu
}

# æ›´æ–°è„šæœ¬
update_script() {
    local remote_url="https://raw.githubusercontent.com/momo97620/momoya/refs/heads/main/vps666"  # æ›¿æ¢ä¸ºå®é™…çš„è¿œç¨‹è„šæœ¬ URL
    local local_path="/root/vps666"

    echo -e "${YELLOW}æ­£åœ¨æ›´æ–°è„šæœ¬åˆ°æœ€æ–°ç‰ˆæœ¬...${NC}"

    # ä¸‹è½½æœ€æ–°è„šæœ¬
    if curl -sSL "$remote_url" -o "$local_path"; then
        chmod +x "$local_path"
        echo -e "${GREEN}è„šæœ¬æ›´æ–°æˆåŠŸï¼æœ€æ–°ç‰ˆæœ¬å·²ä¿å­˜åˆ° $local_pathã€‚${NC}"
    else
        echo -e "${RED}è„šæœ¬æ›´æ–°å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¿œç¨‹ URL æ˜¯å¦æ­£ç¡®ã€‚${NC}"
    fi

    read -p "æŒ‰ä»»æ„é”®è¿”å›ä¸»èœå•..."
}

# æ˜¾ç¤ºä¸»èœå•
show_main_menu() {
    while true; do
        clear
        # ASCII è‰ºæœ¯å±•ç¤º "emoMomo"
        echo -e "${LIGHTCYAN}"
        echo "  ______ _   __  __   __  __          "
        echo " |  ____| | |  \/  | |  \/  |         "
        echo " | |__  | | | \  / | | \  / | ___ _ __ "
        echo " |  __| | | | |\/| | | |\/| |/ _ \ '__|"
        echo " | |    | | | |  | | | |  | |  __/ |   "
        echo " |_|    |_| |_|  |_| |_|  |_|\___|_|   "
        echo -e "${NC}"

        echo -e "${LIGHTCYAN}============================= VPS è„šæœ¬èœå• =============================${NC}"
        echo -e "${LIGHTBLUE}ä½¿ç”¨å¿«æ·æŒ‡ä»¤ m å¯å¿«é€Ÿæ‰“å¼€è„šæœ¬ğŸ˜Š${NC}"
        echo -e "${LIGHTBLUE}ä½œè€…ï¼šemoçš„å°é»˜é»˜${NC}"
        echo -e "${LIGHTCYAN}=====================================================================${NC}"
        
        echo -e "${YELLOW}è¯·é€‰æ‹©è¦æ‰§è¡Œçš„ä»»åŠ¡ï¼š${NC}"

        # ä½¿ç”¨ printf æ ¼å¼åŒ–èœå•é€‰é¡¹ï¼Œç¡®ä¿å¯¹é½
        printf "  ${BRIGHT_MAGENTA}%-30s${NC}  ${BRIGHT_MAGENTA}%-40s${NC}\n" "1. æ­å»º Hysteria èŠ‚ç‚¹"   "6. ä¸€é”®WARP"
        printf "  ${BRIGHT_MAGENTA}%-30s${NC}  ${BRIGHT_MAGENTA}%-40s${NC}\n" "2. å®‰è£…å¹¶é…ç½® UFW é˜²ç«å¢™"  "7. BBRåŠ é€Ÿ"
        printf "  ${BRIGHT_MAGENTA}%-30s${NC}  ${BRIGHT_MAGENTA}%-30s${NC}\n" "3. é…ç½®å¯†é’¥ç™»å½•"          "8. Dockerç®¡ç†"
        printf "  ${BRIGHT_MAGENTA}%-30s${NC}  ${BRIGHT_MAGENTA}%-30s${NC}\n" "4. ä¿®æ”¹ç™»å½•ç«¯å£å·"         "9. ç³»ç»Ÿä¿¡æ¯æŸ¥è¯¢"
        printf "  ${BRIGHT_MAGENTA}%-30s${NC}  ${BRIGHT_MAGENTA}%-30s${NC}\n" "5. ä¸€é”®æ­å»ºèŠ‚ç‚¹"           "10. è®¾ç½® IPv4/6 ä¼˜å…ˆçº§"
        printf "  ${BRIGHT_MAGENTA}%-30s${NC}  ${BRIGHT_MAGENTA}%-30s${NC}\n" "11. æ›´æ–°è„šæœ¬"              "0. é€€å‡º"
        
        echo -e "${LIGHTCYAN}=====================================================================${NC}"
        
        read -p "è¯·è¾“å…¥é€‰é¡¹ (0-11): " choice
        case $choice in
            1)
                execute_script "https://gist.githubusercontent.com/momo97620/68630501ec62d5f6ece848d5e3ffad4e/raw/203246731cde7f6ca90d8b2e934cf0ffa5127cb4/hy2" "æ­å»º Hysteria èŠ‚ç‚¹å®Œæˆã€‚"
                ;;
            2)
                execute_script "https://gist.githubusercontent.com/momo97620/2ecbf06ce959fda14b01c0ce9f34f3d8/raw/ebbbdf08a05c890d72902863c53bf80af9531601/ufw_install.sh" "å®‰è£…å¹¶é…ç½® UFW é˜²ç«å¢™å®Œæˆã€‚"
                ;;
            3)
                execute_script "https://gist.githubusercontent.com/momo97620/035985261aa7f946270590a15ca4c9f6/raw/0a81d05bcbfdf1b3f8c94ba7203044c55f2e030e/miyao" "é…ç½®å¯†é’¥ç™»å½•å®Œæˆã€‚"
                ;;
            4)
                execute_script "https://gist.githubusercontent.com/momo97620/685e1ead90ed0ad379c6a75e27409704/raw/aaeabe347f3612e9c308b898e64bcfd12276a067/duank" "ä¿®æ”¹ç™»å½•ç«¯å£å·å®Œæˆã€‚"
                ;;
            5)
                execute_script "https://github.com/233boy/sing-box/raw/main/install.sh" "ä¸€é”®æ­å»ºèŠ‚ç‚¹å®Œæˆã€‚"
                ;;
            6)
                execute_script "https://gitlab.com/fscarmen/warp/-/raw/main/menu.sh" "ä¸€é”®WARPå®Œæˆã€‚"
                ;;
            7)
                execute_script "https://github.com/ylx2016/Linux-NetSpeed/raw/master/tcp.sh" "BBRåŠ é€Ÿå®Œæˆã€‚"
                ;;
            8)
                execute_script "https://raw.githubusercontent.com/momo97620/momoya/refs/heads/main/docker" "Dockerç®¡ç†å®Œæˆã€‚"
                ;;
            9)
                execute_script "https://raw.githubusercontent.com/momo97620/momoya/main/xitong" "ç³»ç»Ÿä¿¡æ¯æŸ¥è¯¢å®Œæˆã€‚"
                ;;
            10)
                set_ip_priority
                ;;
            11)
                update_script
                ;;
            0)
                echo -e "${GREEN}é€€å‡ºç¨‹åº...${NC}"
                exit 0
                ;;
            *)
                echo -e "${RED}æ— æ•ˆçš„é€‰æ‹©ï¼Œè¯·é‡æ–°è¾“å…¥ï¼${NC}"
                read -p "æŒ‰å›è½¦é”®è¿”å›ä¸»èœå•..."
                ;;
        esac
    done
}

# ä¸»æ‰§è¡Œé€»è¾‘
main() {
    if [[ "$1" == "install" ]]; then
        install_script
        exit 0
    fi

    echo -e "${YELLOW}è„šæœ¬è·¯å¾„: $SCRIPT_PATH${NC}"
    echo -e "${YELLOW}å®‰è£…è·¯å¾„: $INSTALL_DIR${NC}"

    if [ ! -d "$INSTALL_DIR" ]; then
        install_script
    else
        echo -e "${GREEN}è„šæœ¬å·²å®‰è£…åˆ°ï¼š$INSTALL_DIR${NC}"
    fi

    show_main_menu
}

# æ‰§è¡Œä¸»é€»è¾‘
main "$@"