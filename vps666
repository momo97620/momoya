#!/bin/bash

# å®šä¹‰é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
BRIGHT_GREEN='\033[1;32m'  # äº®ç»¿è‰²
YELLOW='\033[0;94m'
BLUE='\033[0;34m'
DARK_RED='\033[1;31m'  # æ·±çº¢è‰²
LIGHTBLUE='\033[1;34m'
LIGHTCYAN='\033[1;36m'
PINK='\033[38;5;198m'  # æ›´æ·±çš„ç²‰è‰²
DEEPRED='\033[0;91m'   # æ·±çº¢è‰²
NC='\033[0m'           # No color
        
# å®šä¹‰ç¬¦å·é“¾æ¥çš„ç›®æ ‡å’Œé“¾æ¥åç§°
LINK_NAME="/usr/local/bin/m"
SCRIPT_PATH="/root/vps666"

# æ£€æŸ¥ç¬¦å·é“¾æ¥æ˜¯å¦å·²ç»å­˜åœ¨
if [ ! -L "$LINK_NAME" ]; then
    ln -s "$SCRIPT_PATH" "$LINK_NAME" > /dev/null 2>&1
else
    # ä»€ä¹ˆéƒ½ä¸åšï¼Œå®Œå…¨éšè—è¾“å‡º
    :
fi

# è·å–è„šæœ¬è·¯å¾„
SCRIPT_PATH=$(realpath "${BASH_SOURCE[0]}")
SCRIPT_DIR=$(dirname "$SCRIPT_PATH")

# å®šä¹‰å›ºå®šå®‰è£…è·¯å¾„
INSTALL_DIR="/root/vps666"

# æ£€æŸ¥è„šæœ¬æ˜¯å¦è¢«ç›´æ¥è¿è¡Œ
if [[ "${BASH_SOURCE[0]}" != "${0}" ]]; then
    exit 1
fi

# æ£€æŸ¥æ˜¯å¦ä»¥ root ç”¨æˆ·è¿è¡Œ
if [ "$(id -u)" != "0" ]; then
    exit 1
fi

# å®‰è£…ä¸»è„šæœ¬
install_script() {
    # éšè—æ‰€æœ‰è¾“å‡ºï¼Œåˆ›å»ºå®‰è£…ç›®å½•å¹¶å®‰è£…è„šæœ¬
    if [ ! -d "$INSTALL_DIR" ]; then
        mkdir -p "$INSTALL_DIR" > /dev/null 2>&1
    fi
    
    cp "$SCRIPT_PATH" "$INSTALL_DIR" > /dev/null 2>&1
    chmod +x "$INSTALL_DIR/$(basename "$SCRIPT_PATH")" > /dev/null 2>&1
}

# åœ¨åå°è¿è¡Œå®‰è£…
install_script &> /dev/null &

# æ‰§è¡Œå­è„šæœ¬
execute_script() {
    local script_url="$1"
    local success_message="$2"
    
    bash <(curl -sSL "$script_url")
    echo -e "${GREEN}$success_message${NC}"
    
    read -p "æŒ‰ä»»æ„é”®è¿”å›ä¸»èœå•..."
}

# è®¾ç½® IPv4/6 ä¼˜å…ˆçº§
set_ip_priority() {
    check_current_priority() {
        if grep -q "net.ipv6.conf.all.disable_ipv6 = 1" /etc/sysctl.conf; then
            echo "å½“å‰ä¼˜å…ˆçº§ï¼šIPv4"
        else
            echo "å½“å‰ä¼˜å…ˆçº§ï¼šIPv6"
        fi
    }

    set_priority() {
        case "$1" in
            1)
                echo "æ­£åœ¨è®¾ç½®ä¼˜å…ˆä½¿ç”¨ IPv4..."
                echo "net.ipv6.conf.all.disable_ipv6 = 1" >> /etc/sysctl.conf
                echo "net.ipv6.conf.default.disable_ipv6 = 1" >> /etc/sysctl.conf
                sysctl -p
                echo "IPv4 ä¼˜å…ˆè®¾ç½®å®Œæˆï¼"
                ;;
            2)
                echo "æ­£åœ¨è®¾ç½®ä¼˜å…ˆä½¿ç”¨ IPv6..."
                sed -i '/net.ipv6.conf.all.disable_ipv6/d' /etc/sysctl.conf
                sed -i '/net.ipv6.conf.default.disable_ipv6/d' /etc/sysctl.conf
                echo "net.ipv6.conf.all.disable_ipv6 = 0" >> /etc/sysctl.conf
                echo "net.ipv6.conf.default.disable_ipv6 = 0" >> /etc/sysctl.conf
                sysctl -p
                echo "IPv6 ä¼˜å…ˆè®¾ç½®å®Œæˆï¼"
                ;;
            *)
                echo "æ— æ•ˆçš„é€‰é¡¹ï¼è¯·è¾“å…¥ '1' æˆ– '2'ã€‚"
                exit 1
                ;;
        esac
    }

    show_menu() {
        clear
        echo "==============================="
        echo " è®¾ç½® IPv4 æˆ– IPv6 ä¼˜å…ˆçº§"
        echo "==============================="
        check_current_priority
        echo "1. ä¼˜å…ˆä½¿ç”¨ IPv4"
        echo "2. ä¼˜å…ˆä½¿ç”¨ IPv6"
        echo "==============================="
        read -p "è¯·è¾“å…¥é€‰é¡¹ [1/2]ï¼š" choice
        set_priority "$choice"
        echo "è®¾ç½®å®Œæˆï¼æŒ‰ä»»æ„é”®é€€å‡º..."
        read -n 1 -s -r
    }

    show_menu
}

# æ›´æ–°è„šæœ¬
update_script() {
    local remote_url="https://raw.githubusercontent.com/momo97620/momoya/refs/heads/main/vps666"
    local local_path="/root/vps666"

    echo -e "${YELLOW}æ­£åœ¨æ›´æ–°è„šæœ¬åˆ°æœ€æ–°ç‰ˆæœ¬...${NC}"

    if curl -sSL "$remote_url" -o "$local_path"; then
        chmod +x "$local_path"
        echo -e "${GREEN}è„šæœ¬æ›´æ–°æˆåŠŸï¼æœ€æ–°ç‰ˆæœ¬å·²ä¿å­˜åˆ° $local_pathã€‚${NC}"
    else
        echo -e "${RED}è„šæœ¬æ›´æ–°å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¿œç¨‹ URL æ˜¯å¦æ­£ç¡®ã€‚${NC}"
    fi

    read -p "æŒ‰ä»»æ„é”®è¿”å›ä¸»èœå•..."
}

set_ssh_keepalive() {
    local config_file="/etc/ssh/sshd_config"
    local interval=60
    local count=10

    echo "æ­£åœ¨é…ç½® SSH å®¢æˆ·ç«¯ä¿æŒè¿æ¥å‚æ•°..."
    if [[ ! -f "$config_file" ]]; then
        echo "é”™è¯¯ï¼šSSH é…ç½®æ–‡ä»¶ $config_file ä¸å­˜åœ¨ã€‚" >&2
        exit 1
    fi

    read -p "æ˜¯å¦ç¡®è®¤ä¿®æ”¹ SSH é…ç½®ï¼Ÿ(y/n): " confirm
    if [[ "$confirm" != "y" ]]; then
        echo "å–æ¶ˆä¿®æ”¹ã€‚"
        exit 0
    fi

    read -p "è¯·è¾“å…¥ ClientAliveInterval å€¼ï¼ˆé»˜è®¤ 60ï¼‰: " user_interval
    if [[ -n "$user_interval" ]]; then
        interval=$user_interval
    fi

    read -p "è¯·è¾“å…¥ ClientAliveCountMax å€¼ï¼ˆé»˜è®¤ 10ï¼‰: " user_count
    if [[ -n "$user_count" ]]; then
        count=$user_count
    fi

    if grep -q '^#\?ClientAliveInterval' "$config_file"; then
        sed -ri "s/^#?.*ClientAliveInterval.*/ClientAliveInterval $interval/" "$config_file"
    else
        echo "ClientAliveInterval $interval" >> "$config_file"
    fi

    if grep -q '^#\?ClientAliveCountMax' "$config_file"; then
        sed -ri "s/^#?.*ClientAliveCountMax.*/ClientAliveCountMax $count/" "$config_file"
    else
        echo "ClientAliveCountMax $count" >> "$config_file"
    fi

    echo "é‡å¯ SSH æœåŠ¡ä»¥åº”ç”¨æ›´æ”¹..."
    sudo systemctl restart sshd
    if [[ $? -eq 0 ]]; then
        echo "SSH é…ç½®å·²æ›´æ–°å¹¶æˆåŠŸåº”ç”¨ï¼"
    else
        echo "SSH æœåŠ¡é‡å¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®ã€‚" >&2
        exit 1
    fi
    echo "æŒ‰ä»»æ„é”®è¿”å›ä¸»èœå•..."
    read -n 1 -s -r
}

# å®šä¹‰å‘½åç©ºé—´
declare -A RAINBOW_PROMPT

# é¢œè‰²ä»£ç å‘½åç©ºé—´
RAINBOW_PROMPT[RED]='\033[0;31m'
RAINBOW_PROMPT[GREEN]='\033[0;32m'
RAINBOW_PROMPT[YELLOW]='\033[0;33m'
RAINBOW_PROMPT[BLUE]='\033[0;34m'
RAINBOW_PROMPT[PURPLE]='\033[0;35m'
RAINBOW_PROMPT[CYAN]='\033[0;36m'
RAINBOW_PROMPT[WHITE]='\033[0;37m'
RAINBOW_PROMPT[RESET]='\033[0m'

# é…ç½®å‘½åç©ºé—´
RAINBOW_PROMPT[BACKUP_FILE]="$HOME/.bashrc.backup"
RAINBOW_PROMPT[BASHRC_FILE]="$HOME/.bashrc"

# å·¥å…·å‡½æ•°å‘½åç©ºé—´
RAINBOW_PROMPT::print_message() {
    local color=$1
    local message=$2
    echo -e "${RAINBOW_PROMPT[$color]}$message${RAINBOW_PROMPT[RESET]}"
}

RAINBOW_PROMPT::show_menu() {
    clear
    echo "================================"
    echo "       VPSä¸»æœºåé¢œè‰²è®¾ç½®        "
    echo "================================"
    echo "1. è®¾ç½®å½©è™¹è‰²ä¸»æœºå"
    echo "2. æ¢å¤é»˜è®¤è®¾ç½®"
    echo "3. é€€å‡ºç¨‹åº"
    echo "================================"
}

RAINBOW_PROMPT::create_backup() {
    if [ ! -f "${RAINBOW_PROMPT[BACKUP_FILE]}" ]; then
        cp "${RAINBOW_PROMPT[BASHRC_FILE]}" "${RAINBOW_PROMPT[BACKUP_FILE]}"
    fi
}

RAINBOW_PROMPT::press_any_key() {
    RAINBOW_PROMPT::print_message "YELLOW" "\næŒ‰ä»»æ„é”®è¿”å›ä¸»èœå•..."
    read -n 1 -s -r
}

# æ ¸å¿ƒåŠŸèƒ½å‘½åç©ºé—´
RAINBOW_PROMPT::create_rainbow_prompt() {
    RAINBOW_PROMPT::create_backup
    
    # ä¿®æ”¹ .bashrc æ–‡ä»¶
    sed -i '/^PS1=/d' "${RAINBOW_PROMPT[BASHRC_FILE]}"
    
    # æ„å»ºå½©è™¹PS1
    local rainbow_ps1="PS1=\""
    rainbow_ps1+="\\[${RAINBOW_PROMPT[RED]}\\]r"
    rainbow_ps1+="\\[${RAINBOW_PROMPT[GREEN]}\\]o"
    rainbow_ps1+="\\[${RAINBOW_PROMPT[YELLOW]}\\]o"
    rainbow_ps1+="\\[${RAINBOW_PROMPT[BLUE]}\\]t"
    rainbow_ps1+="\\[${RAINBOW_PROMPT[PURPLE]}\\]@"
    rainbow_ps1+="\\[${RAINBOW_PROMPT[CYAN]}\\]h"
    rainbow_ps1+="\\[${RAINBOW_PROMPT[RED]}\\]k"
    rainbow_ps1+="\\[${RAINBOW_PROMPT[GREEN]}\\]g"
    rainbow_ps1+="\\[${RAINBOW_PROMPT[YELLOW]}\\]1"
    rainbow_ps1+="\\[${RAINBOW_PROMPT[BLUE]}\\]1"
    rainbow_ps1+="\\[${RAINBOW_PROMPT[PURPLE]}\\]-"
    rainbow_ps1+="\\[${RAINBOW_PROMPT[CYAN]}\\]2"
    rainbow_ps1+="\\[${RAINBOW_PROMPT[RED]}\\]0"
    rainbow_ps1+="\\[${RAINBOW_PROMPT[GREEN]}\\]2"
    rainbow_ps1+="\\[${RAINBOW_PROMPT[YELLOW]}\\]4"
    rainbow_ps1+="\\[${RAINBOW_PROMPT[BLUE]}\\]1"
    rainbow_ps1+="\\[${RAINBOW_PROMPT[PURPLE]}\\]0"
    rainbow_ps1+="\\[${RAINBOW_PROMPT[CYAN]}\\]0"
    rainbow_ps1+="\\[${RAINBOW_PROMPT[RED]}\\]3"
    rainbow_ps1+="\\[${RAINBOW_PROMPT[GREEN]}\\]1"
    rainbow_ps1+="\\[${RAINBOW_PROMPT[YELLOW]}\\]3"
    rainbow_ps1+="\\[${RAINBOW_PROMPT[BLUE]}\\]1"
    rainbow_ps1+="\\[${RAINBOW_PROMPT[PURPLE]}\\]2"
    rainbow_ps1+="\\[${RAINBOW_PROMPT[CYAN]}\\]0"
    rainbow_ps1+="\\[${RAINBOW_PROMPT[RED]}\\]4"
    rainbow_ps1+="\\[${RAINBOW_PROMPT[RESET]}\\]:\\w\\$ \""

    # å†™å…¥æ–°çš„PS1è®¾ç½®
    echo "$rainbow_ps1" >> "${RAINBOW_PROMPT[BASHRC_FILE]}"
    
    source "${RAINBOW_PROMPT[BASHRC_FILE]}"
    RAINBOW_PROMPT::print_message "GREEN" "\nå½©è™¹æ•ˆæœå·²æˆåŠŸåº”ç”¨ï¼"
}

RAINBOW_PROMPT::restore_default() {
    if [ -f "${RAINBOW_PROMPT[BACKUP_FILE]}" ]; then
        cp "${RAINBOW_PROMPT[BACKUP_FILE]}" "${RAINBOW_PROMPT[BASHRC_FILE]}"
        source "${RAINBOW_PROMPT[BASHRC_FILE]}"
        RAINBOW_PROMPT::print_message "GREEN" "\nå·²æˆåŠŸæ¢å¤é»˜è®¤è®¾ç½®ï¼"
    else
        RAINBOW_PROMPT::print_message "RED" "\næœªæ‰¾åˆ°å¤‡ä»½æ–‡ä»¶ï¼Œæ— æ³•æ¢å¤é»˜è®¤è®¾ç½®ï¼"
    fi
}

# ä¸»ç¨‹åºå‘½åç©ºé—´
RAINBOW_PROMPT::main() {
    while true; do
        RAINBOW_PROMPT::show_menu
        read -p "è¯·è¾“å…¥é€‰é¡¹ [1-3]: " choice
        
        case $choice in
            1)
                RAINBOW_PROMPT::print_message "CYAN" "\næ­£åœ¨è®¾ç½®å½©è™¹è‰²ä¸»æœºå..."
                RAINBOW_PROMPT::create_rainbow_prompt
                RAINBOW_PROMPT::press_any_key
                ;;
            2)
                RAINBOW_PROMPT::print_message "CYAN" "\næ­£åœ¨æ¢å¤é»˜è®¤è®¾ç½®..."
                RAINBOW_PROMPT::restore_default
                RAINBOW_PROMPT::press_any_key
                ;;
            3)
                RAINBOW_PROMPT::print_message "GREEN" "\næ„Ÿè°¢ä½¿ç”¨ï¼Œå†è§ï¼"
                exit 0
                ;;
            *)
                RAINBOW_PROMPT::print_message "RED" "\næ— æ•ˆçš„é€‰é¡¹ï¼Œè¯·é‡æ–°é€‰æ‹©ï¼"
                RAINBOW_PROMPT::press_any_key
                ;;
        esac
    done
}

show_main_menu() {
    clear
    # å®šä¹‰é¢œè‰²
    LIGHTCYAN='\033[1;36m'  # æ˜äº®çš„é’è‰²
    NC='\033[0m'  # é‡ç½®é¢œè‰²

    # ASCII è‰ºæœ¯å±•ç¤º "EMoMoMo"
    echo -e "${LIGHTCYAN}"
    echo "  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—"
    echo "  â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—"
    echo "  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘"
    echo "  â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘"
    echo "  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•"
    echo "  â•šâ•â•â•â•â•â•â•â•šâ•â•     â•šâ•â• â•šâ•â•â•â•â•â• â•šâ•â•     â•šâ•â• â•šâ•â•â•â•â•â• â•šâ•â•     â•šâ•â• â•šâ•â•â•â•â•â• "
    echo -e "${NC}"

    echo -e "${LIGHTCYAN}============================= VPS è„šæœ¬èœå• =============================${NC}"
    echo -e "${LIGHTBLUE}ä½¿ç”¨å¿«æ·æŒ‡ä»¤ m å¯å¿«é€Ÿæ‰“å¼€è„šæœ¬ğŸ˜Š${NC}"
    echo -e "${PINK}ä½œè€…ï¼šemoçš„å°é»˜é»˜${NC}"
    echo -e "${LIGHTCYAN}=====================================================================${NC}"
    
    echo -e "${YELLOW}è¯·é€‰æ‹©è¦æ‰§è¡Œçš„ä»»åŠ¡ï¼š${NC}"

    echo -e "  ${BLUE}1.${NC} ${PINK}â™¥${NC} ${GREEN}æ­å»ºhy2èŠ‚ç‚¹${NC}       ${BLUE}09${NC} ${PINK}â™¥${NC} ${LIGHTCYAN}ç³»ç»Ÿä¿¡æ¯æŸ¥è¯¢${NC}"
echo -e "  ${BLUE}2.${NC} ${PINK}â™¥${NC} ${GREEN}UFW é˜²ç«å¢™${NC}        ${BLUE}10${NC} ${PINK}â™¥${NC} ${LIGHTCYAN}IPv4/6ä¼˜å…ˆ${NC}"
echo -e "  ${BLUE}3.${NC} ${PINK}â™¥${NC} ${GREEN}é…ç½®å¯†é’¥ç™»å½•${NC}      ${BLUE}11${NC} ${PINK}â™¥${NC} ${LIGHTCYAN}æ›´æ–°ä¸»è„šæœ¬${NC}"
echo -e "  ${BLUE}4.${NC} ${PINK}â™¥${NC} ${GREEN}ä¿®æ”¹ç™»å½•ç«¯å£${NC}      ${BLUE}12${NC} ${PINK}â™¥${NC} ${YELLOW}ä¿æŒsshè¿æ¥${NC}"
echo -e "  ${BLUE}5.${NC} ${PINK}â™¥${NC} ${GREEN}ä¸€é”®æ­å»ºèŠ‚ç‚¹${NC}      ${BLUE}13${NC} ${PINK}â™¥${NC} ${YELLOW}ä¸€é”®DDç³»ç»Ÿ â–¶${NC}"
echo -e "  ${BLUE}6.${NC} ${PINK}â™¥${NC} ${GREEN}ä¸€é”®é…ç½®WARP${NC}      ${BLUE}14${NC} ${PINK}â™¥${NC} ${RED}ç›‘æ§TGå…³é”®è¯ â–¶${NC}"
echo -e "  ${BLUE}7.${NC} ${PINK}â™¥${NC} ${GREEN}ä¸€é”®BBRåŠ é€Ÿ${NC}       ${BLUE}15${NC} ${PINK}â™¥${NC} ${RED}ä¸»æœºåé¢œè‰²${NC}"
echo -e "  ${BLUE}8.${NC} ${PINK}â™¥${NC} ${LIGHTCYAN}Dockeré¡¹ç›® â–¶${NC}      ${BLUE}16${NC} ${PINK}â™¥${NC} ${RED}æµ‹è¯•æµåª’ä½“${NC}"
echo -e "  ${BLUE}17.${NC} ${PINK}â™¥${NC} ${YELLOW}ä¼˜åŒ–æœåŠ¡å™¨${NC}"
echo -e "  ${BLUE}00${NC} ${PINK}â™¥${NC} ${RED}é€€å‡º${NC}"
read -p "è¯·è¾“å…¥é€‰é¡¹ (0-17): " choice
  
  case "$choice" in
        1)
            execute_script "https://gist.githubusercontent.com/momo97620/68630501ec62d5f6ece848d5e3ffad4e/raw/203246731cde7f6ca90d8b2e934cf0ffa5127cb4/hy2" "æ­å»º Hysteria èŠ‚ç‚¹å®Œæˆã€‚"
            ;;
        2)
            execute_script "https://gist.githubusercontent.com/momo97620/2ecbf06ce959fda14b01c0ce9f34f3d8/raw/ebbbdf08a05c890d72902863c53bf80af9531601/ufw_install.sh" "å®‰è£…å¹¶é…ç½® UFW é˜²ç«å¢™å®Œæˆã€‚"
            ;;
        3)
# é€‰é¡¹ 3: è‡ªåŠ¨ç”³è¯·å¯†é’¥å¹¶é…ç½®å¯†é’¥ç™»å½•
echo "æ‰§è¡Œé€‰é¡¹ 3ï¼šè‡ªåŠ¨ç”³è¯·å¯†é’¥å¹¶é…ç½®å¯†é’¥ç™»å½•..."

# æ£€æŸ¥æ˜¯å¦ä»¥ root ç”¨æˆ·è¿è¡Œ
if [ "$(id -u)" -ne 0 ]; then
    echo "è¯·ä»¥ root ç”¨æˆ·è¿è¡Œæ­¤è„šæœ¬ã€‚"
    read -n 1 -s -r -p "æŒ‰ä»»æ„é”®è¿”å›èœå•..."
    continue
fi

# å®šä¹‰å˜é‡
KEY_DIR="$HOME/.ssh"
PRIVATE_KEY="$KEY_DIR/id_rsa"
PUBLIC_KEY="$KEY_DIR/id_rsa.pub"
SSHD_CONFIG="/etc/ssh/sshd_config"
BACKUP_CONFIG="/etc/ssh/sshd_config.bak"
CLOUD_INIT_CONFIG="/etc/ssh/sshd_config.d/50-cloud-init.conf"
PAM_SSHD_CONFIG="/etc/pam.d/sshd"

# æ­¥éª¤ 1ï¼šç”Ÿæˆå¯†é’¥å¯¹
echo "æ­£åœ¨ç”Ÿæˆå¯†é’¥å¯¹..."
mkdir -p "$KEY_DIR"
chmod 700 "$KEY_DIR"
ssh-keygen -t rsa -b 4096 -f "$PRIVATE_KEY" -N "" -q
if [ $? -ne 0 ]; then
    echo "å¯†é’¥ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç³»ç»Ÿé…ç½®ã€‚"
    read -n 1 -s -r -p "æŒ‰ä»»æ„é”®è¿”å›èœå•..."
    continue
fi
echo "å¯†é’¥ç”ŸæˆæˆåŠŸï¼"
echo "å¯†é’¥æ–‡ä»¶è·¯å¾„ï¼š"
echo "ç§é’¥: $PRIVATE_KEY"
echo "å…¬é’¥: $PUBLIC_KEY"

# æ˜¾ç¤ºå…¬é’¥çš„ ASCII å›¾å½¢åŒ–è¡¨ç¤º
echo "ç”Ÿæˆå…¬é’¥çš„ ASCII å›¾å½¢åŒ–è¡¨ç¤º..."
ssh-keygen -lv -f "$PUBLIC_KEY"

# æ­¥éª¤ 2ï¼šå¤‡ä»½ sshd é…ç½®æ–‡ä»¶
if [ ! -f "$BACKUP_CONFIG" ]; then
    cp "$SSHD_CONFIG" "$BACKUP_CONFIG"
    echo "sshd é…ç½®æ–‡ä»¶å·²å¤‡ä»½åˆ° $BACKUP_CONFIGã€‚"
else
    echo "sshd é…ç½®æ–‡ä»¶å·²å­˜åœ¨å¤‡ä»½ï¼Œè·³è¿‡å¤‡ä»½æ­¥éª¤ã€‚"
fi

# æ­¥éª¤ 3ï¼šé…ç½®å…¬é’¥ç™»å½•
echo "æ­£åœ¨é…ç½®å…¬é’¥ç™»å½•..."
AUTHORIZED_KEYS="$KEY_DIR/authorized_keys"
cat "$PUBLIC_KEY" >> "$AUTHORIZED_KEYS"
chmod 600 "$AUTHORIZED_KEYS"
chown -R "$(whoami):$(whoami)" "$KEY_DIR"
echo "å…¬é’¥å·²æ·»åŠ åˆ° $AUTHORIZED_KEYSã€‚"

# æ­¥éª¤ 4ï¼šä¿®æ”¹ SSH é…ç½®ä»¥ç¦ç”¨å¯†ç ç™»å½•ï¼ˆå»¶è¿Ÿç”Ÿæ•ˆï¼‰
echo "ä¿®æ”¹ SSH é…ç½®ä»¥ç¦ç”¨å¯†ç ç™»å½•..."
if ! grep -q "^PasswordAuthentication" "$SSHD_CONFIG"; then
    echo "PasswordAuthentication yes" >> "$SSHD_CONFIG"
fi
sed -i 's/^PasswordAuthentication yes/PasswordAuthentication no/' "$SSHD_CONFIG"
sed -i 's/^#PasswordAuthentication no/PasswordAuthentication no/' "$SSHD_CONFIG"
if ! grep -q "^PubkeyAuthentication yes" "$SSHD_CONFIG"; then
    echo "PubkeyAuthentication yes" >> "$SSHD_CONFIG"
fi
if ! grep -q "^ChallengeResponseAuthentication no" "$SSHD_CONFIG"; then
    echo "ChallengeResponseAuthentication no" >> "$SSHD_CONFIG"
fi
if grep -q "^UsePAM yes" "$SSHD_CONFIG"; then
    sed -i 's/^UsePAM yes/UsePAM no/' "$SSHD_CONFIG"
fi

# æ­¥éª¤ 5ï¼šæ¸…ç©º cloud-init é…ç½®æ–‡ä»¶å¹¶æ·»åŠ  PasswordAuthentication no
if [ -f "$CLOUD_INIT_CONFIG" ]; then
    echo "æ£€æµ‹åˆ° $CLOUD_INIT_CONFIGï¼Œæ¸…ç©ºæ–‡ä»¶å¹¶æ·»åŠ  PasswordAuthentication no..."
    
    # æ¸…ç©ºæ–‡ä»¶å†…å®¹
    > "$CLOUD_INIT_CONFIG"
    
    # æ·»åŠ é…ç½®
    echo "PasswordAuthentication no" >> "$CLOUD_INIT_CONFIG"

    # ç¡®ä¿ä¿®æ”¹ç”Ÿæ•ˆ
    if grep -q "^PasswordAuthentication no" "$CLOUD_INIT_CONFIG"; then
        echo "æˆåŠŸä¿®æ”¹ $CLOUD_INIT_CONFIG ä¸­çš„ PasswordAuthentication ä¸º noã€‚"
    else
        echo "ä¿®æ”¹ $CLOUD_INIT_CONFIG å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥æ–‡ä»¶ã€‚"
    fi
fi

# æ­¥éª¤ 6ï¼šæ³¨é‡Šæ‰ PAM é…ç½®ä¸­çš„ @include common-auth
if [ -f "$PAM_SSHD_CONFIG" ]; then
    echo "æ³¨é‡Šæ‰ PAM é…ç½®ä¸­çš„ @include common-auth..."
    sed -i 's/^@include common-auth/#@include common-auth/' "$PAM_SSHD_CONFIG"
fi

# æç¤ºç”¨æˆ·å½“å‰ä¼šè¯ä¸ä¼šå¤±æ•ˆ
echo -e "${DARK_RED}é‡è¦æç¤ºï¼š${NC}"
echo -e "${DARK_RED}â€¼ï¸  åˆ‡è®°è¦å…ˆä¿å­˜å¥½ç§é’¥ï¼ï¼ï¼ã€‚${NC}"
echo -e "${DARK_RED}â€¼ï¸  é€€å‡ºèœå•è¾“å…¥ä»¥ä¸‹é‡å¯å‘½ä»¤:${NC}"
echo -e "${DARK_RED}â€¼ï¸  systemctl restart sshd${NC}"
echo -e "${DARK_RED}â€¼ï¸  ç„¶åé‡å¯SSHç¦ç”¨å¯†ç æ‰ä¼šè¢«åŠ è½½ã€ç„¶åç”¨ç§é’¥ç™»å½•${NC}"

echo -e "${BRIGHT_GREEN}å…¬é’¥è·¯å¾„: $PUBLIC_KEY${NC}"
echo -e "${BRIGHT_GREEN}ç§é’¥è·¯å¾„: $PRIVATE_KEY${NC}"

# ç­‰å¾…ç”¨æˆ·æŒ‰ä»»æ„é”®è¿”å›èœå•
echo ""
read -n 1 -s -r -p "æŒ‰ä»»æ„é”®è¿”å›èœå•..."
echo ""
            ;;
        4)
            execute_script "https://gist.githubusercontent.com/momo97620/685e1ead90ed0ad379c6a75e27409704/raw/aaeabe347f3612e9c308b898e64bcfd12276a067/duank" "ä¿®æ”¹ç™»å½•ç«¯å£å·å®Œæˆã€‚"
            ;;
        5)
            execute_script "https://github.com/233boy/sing-box/raw/main/install.sh" "ä¸€é”®æ­å»ºèŠ‚ç‚¹å®Œæˆã€‚"
            ;;
        6)
            execute_script "https://gitlab.com/fscarmen/warp/-/raw/main/menu.sh" "ä¸€é”®WARPå®Œæˆã€‚"
            ;;
        7)
            execute_script "https://github.com/ylx2016/Linux-NetSpeed/raw/master/tcp.sh" "BBRåŠ é€Ÿå®Œæˆã€‚"
            ;;
        8)
            # è°ƒç”¨ç³»ç»Ÿç®¡ç†èœå•
while true; do
    clear  # æ¸…é™¤å±å¹•
    # å‡½æ•°ï¼šæ£€æµ‹ LDNMP ç¯å¢ƒ
check_ldnmp() {
    # æ£€æµ‹ PHP ç‰ˆæœ¬
    if command -v php &> /dev/null; then
        php_version="PHP: $(php -v | head -n 1 | awk '{print $2}')"
    else
        php_version="PHP: æœªå®‰è£…"
    fi

    # æ£€æµ‹ MySQL ç‰ˆæœ¬
    if command -v mysql &> /dev/null; then
        mysql_version="MySQL: $(mysql --version | awk '{print $5}')"
    else
        mysql_version="MySQL: æœªå®‰è£…"
    fi

    # æ£€æµ‹ Nginx ç‰ˆæœ¬
    if command -v nginx &> /dev/null; then
        nginx_version="Nginx: $(nginx -v 2>&1 | awk -F/ '{print $2}')"
    else
        nginx_version="Nginx: æœªå®‰è£…"
    fi

    # æ£€æµ‹ Docker ç‰ˆæœ¬
    if command -v docker &> /dev/null; then
        docker_version="Docker: $(docker --version | awk '{print $3}' | sed 's/,//')"
    else
        docker_version="Docker: æœªå®‰è£…"
    fi
              echo -e "${BLUE}\n===== LDNMP ç¯å¢ƒæ£€æµ‹ =====${NC}"
    # è¾“å‡ºç»“æœä¸ºä¸€æ’
    echo -e "${BOLD_GREEN} ${docker_version} | ${mysql_version} | ${php_version} | ${nginx_version}${NC}"
    
    echo -e "${DEEPRED}-----------------------------${NC}"
}
# è‡ªåŠ¨æ£€æµ‹ LDNMP ç¯å¢ƒ
check_ldnmp 
    echo -e "${GREEN}1.${NC} ${LIGHTBLUE}dockerå®‰è£…${NC}    ${YELLOW}2.${NC} ${PINK}NextChatGPT${NC}"
    echo -e "----------------------------"
    echo -e "${BLUE}3.${NC} ${LIGHTCYAN}éƒ¨ç½²RSSHub${NC}    ${LIGHTBLUE}4.${NC} ${GREEN}Lsky-Proå›¾åºŠ${NC}"
    echo -e "----------------------------"
    echo -e "${DEEPRED}0.${NC} ${RED}è¿”å›ä¸»èœå•${NC}"
    echo -e "============================"
    # æç¤ºç”¨æˆ·å®‰è£… Docker
echo -e "${LIGHTCYAN}âš ï¸ æ‰€æœ‰é¡¹ç›®å®‰è£…å‰éœ€è¦å…ˆå®‰è£… Dockerï¼å¦åˆ™æç¤ºå®‰è£…å¤±è´¥ã€‚${NC}"

    read -p "è¯·è¾“å…¥ä½ çš„é€‰æ‹© [1-4, 0]: " sys_choice

    case $sys_choice in
        1)
            execute_script "https://raw.githubusercontent.com/momo97620/momoya/refs/heads/main/docker" "Dockerç®¡ç†å®Œæˆã€‚"
            ;;
        2)
            clear  # æ¸…é™¤å±å¹•
            # é¢œè‰²å®šä¹‰
GREEN='\033[0;32m'
RED='\033[0;31m'
DEEPRED='\033[1;31m'  # æ·±çº¢è‰²
NC='\033[0m'          # æ— é¢œè‰²

# æ£€æŸ¥å¹¶è®¾ç½® locale
if ! grep -q "export LANG=en_US.UTF-8" ~/.bashrc; then
    echo "export LANG=en_US.UTF-8" >> ~/.bashrc
fi

if ! grep -q "export LC_ALL=en_US.UTF-8" ~/.bashrc; then
    echo "export LC_ALL=en_US.UTF-8" >> ~/.bashrc
fi

# ç«‹å³ç”Ÿæ•ˆ
export LANG=en_US.UTF-8
export LC_ALL=en_US.UTF-8

setup_nextchat() {
    # è®¾ç½®å·¥ä½œç›®å½•
    local work="/docker/nextchat"
    mkdir -p "$work" && cd "$work" || { echo "æ— æ³•è¿›å…¥å·¥ä½œç›®å½•"; exit 1; }

    # åˆ›å»º docker-compose.yml æ–‡ä»¶å¹¶å†™å…¥åŸºç¡€é…ç½®
    cat <<EOL > docker-compose.yml
version: '3'
services:
  chatgpt-next-web:
    container_name: nextchat
    image: yidadaa/chatgpt-next-web:latest
    restart: always
    ports:
      - "8842:3000"
    environment:
      - OPENAI_API_KEY=sk-xxx #ä½ çš„api key
      - CODE=emomomo  #å¯†ç 
      - BASE_URL=https://xx.xx.io #ç¬¬ä¸‰æ–¹ä»£ç†åœ°å€
      - DEFAULT_MODEL=gpt-4o-mini  #é»˜è®¤æ¨¡å‹
      - ENABLE_BALANCE_QUERY=1  #å¯ç”¨ä½™é¢æŸ¥è¯¢
# 
# æ³¨æ„ä¿®æ”¹æ¢æˆä½ çš„keyä»¤ç‰Œ.ç„¶åä¿®æ”¹ä»£ç†åœ°å€:

# ä¿®æ”¹ä»£ç†åœ°å€(å°±æ˜¯ä½ å–api keyçš„ç½‘ç«™ä»–ä»¬è¦æ±‚å¡«ä»–ä»¬çš„ç¬¬ä¸‰æ–¹åœ°å€)

# åå°ç®¡ç†å‘˜å¯†ç é»˜è®¤(emomomo)  å…¶ä»–ä¸ç”¨ä¿®æ”¹

# ä¿®æ”¹å®ŒæˆåæŒ‰ä½ctrlä¸æ”¾ç„¶åå†æŒ‰x  ç„¶åæŒ‰yå›è½¦(ä¿å­˜)
EOL

    # ä½¿ç”¨ nano ç¼–è¾‘å™¨æ‰“å¼€ docker-compose.yml ä¾›ç”¨æˆ·ä¿®æ”¹
    nano docker-compose.yml

    # ç”¨æˆ·ä¿å­˜é€€å‡ºåï¼Œè‡ªåŠ¨è¿è¡Œ docker-compose up -d
    if docker-compose up -d; then
        echo -e "${GREEN}âœ… Docker å®¹å™¨å¯åŠ¨æˆåŠŸï¼${NC}"
    else
        echo -e "${RED}âŒ Docker å®¹å™¨å¯åŠ¨å¤±è´¥ï¼è¯·æ£€æŸ¥æ˜¯å¦å®‰è£…docker-composeã€‚${NC}"
        exit 1
    fi

    # æç¤ºç”¨æˆ·
    echo -e "${DEEPRED}1.${NC} âš ï¸ ${DEEPRED}è¯·æ‰‹åŠ¨æ”¾è¡Œ8842ç«¯å£ï¼ï¼${NC}"
    echo -e "${DEEPRED}2.${NC} âš ï¸ ${DEEPRED}åå°ç™»å½•æ–¹å¼ï¼šæœ¬æœºIP+8842ï¼ï¼${NC}"
    
    # ç­‰å¾…ç”¨æˆ·æŒ‰ä»»æ„é”®è¿”å›ä¸»èœå•
    read -n 1 -s -r -p "æŒ‰ä»»æ„é”®è¿”å›ä¸»èœå•..."
}

# è°ƒç”¨å‡½æ•°
setup_nextchat
           ;;
        3)
            # åˆ›å»ºä¸€ä¸ª 1GB çš„äº¤æ¢æ–‡ä»¶
sudo fallocate -l 1G /swapfile
# è®¾ç½®æ­£ç¡®çš„æƒé™
sudo chmod 600 /swapfile
# å°†æ–‡ä»¶è®¾ç½®ä¸ºäº¤æ¢ç©ºé—´
sudo mkswap /swapfile
# å¯ç”¨äº¤æ¢ç©ºé—´
sudo swapon /swapfile
# ç¡®ä¿åœ¨é‡å¯åè‡ªåŠ¨å¯ç”¨äº¤æ¢ç©ºé—´
echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab

echo "å¼€å§‹éƒ¨ç½² RSSHub..."
hostname=$(hostname)
echo "æœ¬æœºå: $hostname"

# æ£€æŸ¥æ˜¯å¦å·²å®‰è£… RSSHub
if docker ps -a --format '{{.Names}}' | grep -qw rsshub; then
    echo "RSSHub å·²å®‰è£…ã€‚"
    echo
    read -n 1 -s -r -p "æŒ‰ä»»æ„é”®è¿”å›èœå•..."
else
    echo "æ­£åœ¨æ‹‰å– RSSHub é•œåƒ..."
    if ! docker pull diygod/rsshub; then
        echo "æ‹‰å– RSSHub é•œåƒå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼"
        exit 1
    fi

    echo "æ­£åœ¨è¿è¡Œ RSSHub å®¹å™¨..."
    if ! docker run -d --name rsshub -p 1200:1200 diygod/rsshub; then
        echo "è¿è¡Œ RSSHub å®¹å™¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Docker è®¾ç½®ï¼"
        exit 1
    fi

    echo "RSSHub éƒ¨ç½²å®Œæˆï¼ç«¯å£ï¼š1200"
    echo
    read -n 1 -s -r -p "æ“ä½œå®Œæˆï¼ŒæŒ‰ä»»æ„é”®è¿”å›èœå•..."
fi
      ;;
        4)
            # é€‰é¡¹ 4 çš„ç°æœ‰ä»£ç 
echo "å¼€å§‹å®‰è£… Lsky-Pro..."

# åˆ›å»ºç›®å½•å¹¶èµ‹äºˆæƒé™
mkdir -p /root/data/docker_data/lsky-pro
chmod 755 /root/data/docker_data/lsky-pro

# è¿›å…¥ç›®å½•
cd /root/data/docker_data/lsky-pro || { echo "æ— æ³•è¿›å…¥ç›®å½•"; exit 1; }

# åˆ›å»ºé…ç½®æ–‡ä»¶å¹¶èµ‹äºˆæƒé™
touch docker-compose.yml
chmod 644 docker-compose.yml

# å†™å…¥å†…å®¹åˆ° docker-compose.yml
cat <<EOL > docker-compose.yml
version: '3'
services:
    lsky-pro:
        container_name: lsky-pro
        image: dko0/lsky-pro
        restart: always
        volumes:
            - /root/data/docker_data/lsky-pro/lsky-pro-data:/var/www/html  #æ˜ å°„åˆ°æœ¬åœ°
        ports:
            - 8008:80
        environment:
            - MYSQL_HOST=mysql
            - MYSQL_DATABASE=lsky-pro
            - MYSQL_USER=lsky-pro
            - MYSQL_PASSWORD=lsky-pro

    mysql:
        image: mysql:8.1.0
        container_name: lsky-pro-db
        restart: always
        environment:
          - MYSQL_DATABASE=lsky-pro
          - MYSQL_USER=lsky-pro
          - MYSQL_PASSWORD=lsky-pro
          - MYSQL_ROOT_PASSWORD=lsky-pro
        volumes:
          - /root/data/docker_data/lsky-pro/db:/var/lib/mysql
EOL

# è¿è¡Œ Docker Compose
if docker compose up -d; then
    echo "å®‰è£…æˆåŠŸï¼"
else
    echo "å®‰è£…å¤±è´¥ï¼"
    exit 1
fi

# æ˜¾ç¤ºæœ¬æœº IP åœ°å€å’Œç«¯å£ä¿¡æ¯
IP_ADDRESS=$(hostname -I | awk '{print $1}')
echo -e "${DEEPRED}è¯·è®¿é—®ä»¥ä¸‹åœ°å€è¿›è¡Œç™»å½•ï¼šhttp://$IP_ADDRESS:8008${NC}"

# æç¤ºç”¨æˆ·æ”¾è¡Œç«¯å£
echo -e "${DEEPRED}æ³¨æ„ï¼šè¯·ç¡®ä¿æ”¾è¡Œ 8008 ç«¯å£ä»¥ä¾¿è®¿é—® Lsky-Proï¼${NC}"

# ç­‰å¾…ç”¨æˆ·è¾“å…¥ä»»æ„é”®è¿”å›
read -p "æŒ‰ä»»æ„é”®è¿”å›..."
            ;;
        0)
            echo "è¿”å›ä¸»èœå•..."
            break
            ;;
        *)
            clear  # æ¸…é™¤å±å¹•
            echo "æ— æ•ˆé€‰æ‹©ï¼Œè¯·é‡æ–°è¾“å…¥ï¼"
            read -p "æŒ‰ä»»æ„é”®ç»§ç»­..."
            ;;
    esac
done
            ;;
        9)
            execute_script "https://raw.githubusercontent.com/momo97620/momoya/main/xitong" "ç³»ç»Ÿä¿¡æ¯æŸ¥è¯¢å®Œæˆã€‚"
            ;;
        10)
            set_ip_priority
            ;;
        11)
            update_script
            ;;
        12) 
            set_ssh_keepalive
            ;;
        13) 
 while true; do
    clear
    echo -e "${BLUE}----------------------------------------${NC}"
echo -e "${BLUE}            DDé‡è£…ç³»ç»Ÿ            ${NC}"
echo -e "${BLUE}----------------------------------------${NC}"
echo -e "\n${BLUE}~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~${NC}\n"  # ç¾åŒ–ç©ºè¡Œ

echo -e "${GREEN}1.${NC} å›½å¤–æœåŠ¡å™¨"
echo -e "\n${BLUE}~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~${NC}\n"  # ç¾åŒ–ç©ºè¡Œ
echo -e "${GREEN}2.${NC} å›½å†…æœåŠ¡å™¨"
echo -e "\n${BLUE}~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~${NC}\n"  # ç¾åŒ–ç©ºè¡Œ
echo -e "${GREEN}3.${NC} è¿”å›ä¸»èœå•"
echo -e "\n${BLUE}~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~${NC}\n"  # ç¾åŒ–ç©ºè¡Œ
echo -e "\n"  # æ·»åŠ ç©ºè¡Œ
# æç¤ºç”¨æˆ·è¾“å…¥é€‰é¡¹
read -p "è¯·è¾“å…¥é€‰é¡¹ [1-3]: " sub_choice  

    case $sub_choice in
        1)
            curl -O https://raw.githubusercontent.com/bin456789/reinstall/main/reinstall.sh || wget -O reinstall.sh $_
            ;;
        2)
            curl -O https://jihulab.com/bin456789/reinstall/-/raw/main/reinstall.sh || wget -O reinstall.sh $_
            ;;
        3)
            break
            ;;
        *)
            echo -e "${RED}æ— æ•ˆé€‰é¡¹!${NC}"
            sleep 2
            continue
            ;;
    esac

    # èµ‹äºˆæƒé™
    chmod +x reinstall.sh
    # è·³è½¬åˆ°ä¸‹ä¸€ä¸ªå­èœå•
    while true; do
        clear
        echo -e "${BLUE}----------------------------------------${NC}"
        echo -e "${BLUE}            é€‰æ‹©æ‚¨çš„ç³»ç»Ÿç‰ˆæœ¬            ${NC}"
        echo -e "${BLUE}----------------------------------------${NC}"
        echo -e "${GREEN}1.${NC} Debian 10"
        echo -e "${GREEN}2.${NC} Debian 11"
        echo -e "${GREEN}3.${NC} Debian 12"
        echo -e "${GREEN}4.${NC} Ubuntu 16.04"
        echo -e "${GREEN}5.${NC} Ubuntu 18.04"
        echo -e "${GREEN}6.${NC} Ubuntu 20.04"
        echo -e "${GREEN}7.${NC} Ubuntu 24.04"
        echo -e "${GREEN}8.${NC} è¿”å›ä¸Šçº§èœå•"
        echo -e "${BLUE}----------------------------------------${NC}"
        read -p "è¯·è¾“å…¥é€‰é¡¹ [1-8]: " version_choice

        case $version_choice in
            1)
                bash reinstall.sh "Debian 10"
                ;;
            2)
                bash reinstall.sh "Debian 11"
                ;;
            3)
                bash reinstall.sh "Debian 12"
                ;;
            4)
                bash reinstall.sh "Ubuntu 16.04"
                ;;
            5)
                bash reinstall.sh "Ubuntu 18.04"
                ;;
            6)
                bash reinstall.sh "Ubuntu 20.04"
                ;;
            7)
                bash reinstall.sh "Ubuntu 24.04"
                ;;
            8)
                break
                ;;
            *)
                echo -e "${RED}æ— æ•ˆé€‰é¡¹!${NC}"
                sleep 2
                ;;
        esac
    done
done

            ;;  
        14) 
             execute_script "https://raw.githubusercontent.com/ecouus/Feed-Push/refs/heads/main/bot_deploy.sh" "TGå…³é”®è¯è®¢é˜…éƒ¨ç½²å®Œæˆã€‚"
            ;;  
        15)
            RAINBOW_PROMPT::main
            ;;
        16)
            while true; do
            clear
            echo -e "${BLUE}----------------------------------------${NC}"
            echo -e "${BLUE}            æµ‹è¯•æµåª’ä½“å­èœå•            ${NC}"
            echo -e "${BLUE}----------------------------------------${NC}"
            echo -e "${GREEN}1.${NC} æµåª’ä½“æµ‹è¯•"
            echo -e "${GREEN}2.${NC} èåˆæ€ªæµ‹è¯•"
            echo -e "${GREEN}3.${NC} è¿”å›ä¸»èœå•"
            echo -e "${BLUE}----------------------------------------${NC}"
            read -p "è¯·è¾“å…¥é€‰é¡¹ [1-3]: " sub_choice

        case $sub_choice in
            1)
                bash <(curl -sL IP.Check.Place)
                ;;
            2)
                curl -L https://gitlab.com/spiritysdx/za/-/raw/main/ecs.sh -o ecs.sh && chmod +x ecs.sh && bash ecs.sh
                ;;
            3)
                break
                ;;
            *)
                echo -e "${RED}æ— æ•ˆé€‰é¡¹!${NC}"
                sleep 2
                ;;
        esac
    done
    ;;

        0)
            echo -e "${GREEN}é€€å‡ºç¨‹åº...${NC}"
            exit 0
            ;;
        *)
            echo -e "${RED}æ— æ•ˆçš„é€‰æ‹©ï¼Œè¯·é‡æ–°è¾“å…¥ï¼${NC}"
            read -p "æŒ‰å›è½¦é”®è¿”å›ä¸»èœå•..."
            ;;
    esac
}
       
       17)
      set -euo pipefail

LOG_FILE="/var/log/server-optimization.log"
BACKUP_DIR="/root/system_backup"

declare release=""
declare -i total_memory_mb=0
declare -i cpu_cores=0
declare -i cpu_threads=0

CSI="\033["
CEND="${CSI}0m"
CRED="${CSI}1;31m"
CGREEN="${CSI}1;32m"
CYELLOW="${CSI}1;33m"
CCYAN="${CSI}1;36m"

OUT_ALERT() { echo -e "${CYELLOW}$1${CEND}" | tee -a "${LOG_FILE}"; }
OUT_ERROR() { echo -e "${CRED}$1${CEND}" | tee -a "${LOG_FILE}"; }
OUT_INFO() { echo -e "${CCYAN}$1${CEND}" | tee -a "${LOG_FILE}"; }
OUT_SUCCESS() { echo -e "${CGREEN}$1${CEND}" | tee -a "${LOG_FILE}"; }

check_location() { 
    OUT_INFO "[ä¿¡æ¯] æ­£åœ¨æ£€æŸ¥æœåŠ¡å™¨ä½ç½®..."
    
    if ! location_info=$(curl -s "https://ipinfo.io"); then
        OUT_ERROR "[é”™è¯¯] æ— æ³•è·å–ä½ç½®ä¿¡æ¯ï¼Œé»˜è®¤ä½¿ç”¨å›½é™…é…ç½®"
        echo "false"
        return 1
    fi
    
    local country
    country=$(echo "${location_info}" | grep -o '"country": "[^"]*' | cut -d'"' -f4)
    
    if [ "${country}" = "CN" ]; then
        OUT_INFO "[ä¿¡æ¯] æ£€æµ‹åˆ°æœåŠ¡å™¨ä½äºä¸­å›½"
        echo "true"
    else
        OUT_INFO "[ä¿¡æ¯] æ£€æµ‹åˆ°æœåŠ¡å™¨ä½äºæµ·å¤–ï¼š${country}"
        echo "false"
    fi
}

check_root() { 
    if [ $EUID -ne 0 ]; then
        OUT_ERROR "[é”™è¯¯] æ­¤è„šæœ¬éœ€è¦rootæƒé™è¿è¡Œ"
        return 1
    fi
}

check_system() { 
    if [ -f /etc/os-release ]; then
        source /etc/os-release
        if echo "${ID}" | grep -qi "debian"; then
            release="debian"
            return 0
        elif echo "${ID}" | grep -qi "ubuntu"; then
            release="ubuntu"
            return 0
        elif echo "${ID}" | grep -qi "centos|rhel|fedora"; then
            release="centos"
            return 0
        fi
    fi
    
    if [ -f /etc/redhat-release ]; then
        release="centos"
        return 0
    fi
    
    if [ -f /etc/debian_version ]; then
        release="debian"
        return 0
    fi
    
    if grep -qi "debian" /etc/issue; then
        release="debian"
        return 0
    fi
    
    if grep -qi "ubuntu" /etc/issue; then
        release="ubuntu"
        return 0
    fi
    
    if grep -qi "centos|red hat|redhat" /etc/issue; then
        release="centos"
        return 0
    fi
    
    OUT_ERROR "[é”™è¯¯] ä¸æ”¯æŒçš„æ“ä½œç³»ç»Ÿï¼"
    OUT_INFO "ç³»ç»Ÿä¿¡æ¯ï¼š"
    if [ -f /etc/os-release ]; then
        cat /etc/os-release
    fi
    return 1
}

detect_cpu() {
    OUT_INFO "[ä¿¡æ¯] æ£€æµ‹CPUé…ç½®..."
    
    if [ ! -f /proc/cpuinfo ]; then
        OUT_ERROR "[é”™è¯¯] æ— æ³•è®¿é—® /proc/cpuinfo"
        return 1
    fi
    
    cpu_cores=$(grep "cpu cores" /proc/cpuinfo | uniq | awk '{print $4}')
    if [ -z "$cpu_cores" ]; then
        OUT_ERROR "[é”™è¯¯] æ— æ³•è·å–CPUæ ¸å¿ƒæ•°"
        return 1
    fi
    
    cpu_threads=$(grep "siblings" /proc/cpuinfo | uniq | awk '{print $3}')
    if [ -z "$cpu_threads" ]; then
        cpu_threads=$(grep -c processor /proc/cpuinfo)
    fi
    
    local cpu_model
    cpu_model=$(grep "model name" /proc/cpuinfo | head -n1 | cut -d':' -f2 | tr -s ' ')
    
    OUT_INFO "[ä¿¡æ¯] CPUå‹å·: ${cpu_model}"
    OUT_INFO "[ä¿¡æ¯] CPUç‰©ç†æ ¸å¿ƒæ•°: ${cpu_cores}"
    OUT_INFO "[ä¿¡æ¯] CPUé€»è¾‘æ ¸å¿ƒæ•°: ${cpu_threads}"
}

detect_memory() {
    OUT_INFO "[ä¿¡æ¯] æ£€æµ‹å†…å­˜é…ç½®..."
    
    if [ -f /proc/meminfo ]; then
        total_memory_mb=$(grep MemTotal /proc/meminfo | awk '{print int($2/1024)}')
    else
        OUT_ERROR "[é”™è¯¯] æ— æ³•æ£€æµ‹å†…å­˜å¤§å°"
        return 1
    fi
    
    OUT_INFO "[ä¿¡æ¯] æ€»å†…å­˜: ${total_memory_mb}MB"
}

install_requirements() { 
    OUT_INFO "[ä¿¡æ¯] å®‰è£…å¿…è¦å·¥å…·..."
    
    if [ "${release}" = "centos" ]; then
        if ! yum install -y epel-release; then
            OUT_ERROR "[é”™è¯¯] å®‰è£… epel-release å¤±è´¥"
            return 1
        fi
        
        if ! yum install -y wget curl chrony; then
            OUT_ERROR "[é”™è¯¯] å®‰è£…å¿…è¦å·¥å…·å¤±è´¥"
            return 1
        fi
    else
        if ! apt-get update; then
            OUT_ERROR "[é”™è¯¯] æ›´æ–°è½¯ä»¶æºå¤±è´¥"
            return 1
        fi
        
        if ! apt-get install -y wget curl chrony; then
            OUT_ERROR "[é”™è¯¯] å®‰è£…å¿…è¦å·¥å…·å¤±è´¥"
            return 1
        fi
    fi
    
    OUT_SUCCESS "[æˆåŠŸ] å·¥å…·å®‰è£…å®Œæˆ"
    return 0
}

configure_dns() { 
    OUT_INFO "é…ç½®ç³»ç»ŸDNS..."
    
    local is_in_china
    is_in_china=$(check_location)

    if [ ! -d "${BACKUP_DIR}" ]; then
        if ! mkdir -p "${BACKUP_DIR}"; then
            OUT_ERROR "æ— æ³•åˆ›å»ºå¤‡ä»½ç›®å½•ï¼š${BACKUP_DIR}"
            return 1
        fi
    fi

    if [ -L /etc/resolv.conf ]; then
        if ! rm -f /etc/resolv.conf; then
            OUT_ERROR "æ— æ³•åˆ é™¤ resolv.conf ç¬¦å·é“¾æ¥"
            return 1
        fi
    fi
    
    if [ -f /etc/resolv.conf ]; then
        chattr -i /etc/resolv.conf 2>/dev/null || true
        if ! mv /etc/resolv.conf "${BACKUP_DIR}/resolv.conf.bak"; then
            OUT_ERROR "æ— æ³•å¤‡ä»½ /etc/resolv.conf æ–‡ä»¶"
            return 1
        fi
    fi

    if [ "${is_in_china}" = "true" ]; then
        if ! cat > /etc/resolv.conf << 'EOF'
options timeout:2 attempts:3 rotate
nameserver 223.5.5.5
nameserver 223.6.6.6
nameserver 119.29.29.29
nameserver 180.76.76.76
EOF
        then
            OUT_ERROR "æ— æ³•å†™å…¥DNSé…ç½®"
            return 1
        fi
        OUT_INFO "å·²é…ç½®å›½å†…DNS"
    else
        if ! cat > /etc/resolv.conf << 'EOF'
options timeout:2 attempts:3 rotate
nameserver 1.1.1.1
nameserver 8.8.8.8
nameserver 9.9.9.9
nameserver 208.67.222.222
EOF
        then
            OUT_ERROR "æ— æ³•å†™å…¥DNSé…ç½®"
            return 1
        fi
        OUT_INFO "å·²é…ç½®å›½é™…DNS"
    fi

    if ! chattr +i /etc/resolv.conf; then
        OUT_ERROR "æ— æ³•è®¾ç½® /etc/resolv.conf ä¸ºåªè¯»"
        return 1
    fi

    OUT_SUCCESS "DNSé…ç½®å®Œæˆ"
    return 0
}

configure_ntp() { 
    OUT_INFO "é…ç½®NTPæ—¶é—´åŒæ­¥..."
    
    local is_in_china
    is_in_china=$(check_location)

    NTP_SERVICE="chrony.service"

    if [ "${is_in_china}" = "true" ]; then
        if ! cat > /etc/chrony.conf << 'EOF'
server ntp.aliyun.com iburst
server cn.ntp.org.cn iburst
server ntp.tencent.com iburst
driftfile /var/lib/chrony/drift
makestep 1.0 3
rtcsync
logdir /var/log/chrony
EOF
        then
            OUT_ERROR "æ— æ³•å†™å…¥ chrony é…ç½®æ–‡ä»¶"
            return 1
        fi
        OUT_INFO "å·²é…ç½®å›½å†…NTPæœåŠ¡å™¨"
    else
        if ! cat > /etc/chrony.conf << 'EOF'
pool pool.ntp.org iburst
pool time.google.com iburst
pool time.cloudflare.com iburst
driftfile /var/lib/chrony/drift
makestep 1.0 3
rtcsync
logdir /var/log/chrony
EOF
        then
            OUT_ERROR "æ— æ³•å†™å…¥ chrony é…ç½®æ–‡ä»¶"
            return 1
        fi
        OUT_INFO "å·²é…ç½®å›½é™…NTPæœåŠ¡å™¨"
    fi

    if ! systemctl enable "${NTP_SERVICE}"; then
        OUT_ERROR "æ— æ³•å¯ç”¨ NTP æœåŠ¡ï¼š${NTP_SERVICE}"
        return 1
    fi
    
    if ! systemctl restart "${NTP_SERVICE}"; then
        OUT_ERROR "æ— æ³•é‡å¯ NTP æœåŠ¡ï¼š${NTP_SERVICE}"
        return 1
    fi

    OUT_SUCCESS "NTPé…ç½®å®Œæˆ"
    return 0
}

generate_optimization_params() {
    local mem_gb=$((total_memory_mb/1024))
    local params=""
    
    if [ $total_memory_mb -eq 0 ] || [ $cpu_cores -eq 0 ]; then
        OUT_ALERT "[è­¦å‘Š] æ— æ³•æ£€æµ‹ç¡¬ä»¶é…ç½®ï¼Œä½¿ç”¨ä¿å®ˆå‚æ•°é…ç½®"
        params="net.ipv4.tcp_mem = 98304 131072 196608
net.ipv4.tcp_rmem = 4096 87380 16777216
net.ipv4.tcp_wmem = 4096 87380 16777216
net.core.rmem_max = 16777216
net.core.wmem_max = 16777216
net.core.rmem_default = 262144
net.core.wmem_default = 262144
net.core.netdev_max_backlog = 5000
net.core.somaxconn = 1024"
        echo "${params}"
        return 0
    fi
    
    if [ $mem_gb -le 4 ]; then
        params="net.ipv4.tcp_mem = 131072 196608 262144
net.ipv4.tcp_rmem = 4096 131072 33554432
net.ipv4.tcp_wmem = 4096 131072 33554432
net.core.rmem_max = 33554432
net.core.wmem_max = 33554432
net.core.rmem_default = 524288
net.core.wmem_default = 524288"
    elif [ $mem_gb -le 16 ]; then
        params="net.ipv4.tcp_mem = 1048576 1572864 2097152
net.ipv4.tcp_rmem = 4096 262144 67108864
net.ipv4.tcp_wmem = 4096 262144 67108864
net.core.rmem_max = 67108864
net.core.wmem_max = 67108864
net.core.rmem_default = 1048576
net.core.wmem_default = 1048576"
    else
        params="net.ipv4.tcp_mem = 2097152 3145728 4194304
net.ipv4.tcp_rmem = 4096 524288 134217728
net.ipv4.tcp_wmem = 4096 524288 134217728
net.core.rmem_max = 134217728
net.core.wmem_max = 134217728
net.core.rmem_default = 2097152
net.core.wmem_default = 2097152"
    fi
    
    if [ $cpu_cores -le 2 ]; then
        params="${params}
net.core.netdev_max_backlog = 10000
net.core.somaxconn = 2048"
    elif [ $cpu_cores -le 4 ]; then
        params="${params}
net.core.netdev_max_backlog = 30000
net.core.somaxconn = 8192"
    else
        params="${params}
net.core.netdev_max_backlog = 100000
net.core.somaxconn = 65535"
    fi
    
    echo "${params}"
    return 0
}

optimize_system() { 
    OUT_INFO "[ä¿¡æ¯] ä¼˜åŒ–ç³»ç»Ÿå‚æ•°..."
    
    if ! detect_cpu || ! detect_memory; then
        OUT_ERROR "[é”™è¯¯] ç¡¬ä»¶æ£€æµ‹å¤±è´¥"
        return 1
    fi
    
    if [ -f /etc/sysctl.conf ] && \
       ! cp -f /etc/sysctl.conf "${BACKUP_DIR}/sysctl.conf.bak"; then
        OUT_ERROR "[é”™è¯¯] æ— æ³•å¤‡ä»½sysctl.conf"
        return 1
    fi
    
    local optimization_params
    optimization_params=$(generate_optimization_params)
    
    if ! cat > /etc/sysctl.conf << EOF
net.ipv4.ip_forward = 1
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_fin_timeout = 15
net.ipv4.tcp_keepalive_time = 300
net.ipv4.tcp_keepalive_intvl = 20
net.ipv4.tcp_keepalive_probes = 3
net.ipv4.ip_local_port_range = 1024 65535
net.ipv4.tcp_max_tw_buckets = 550000
net.ipv4.tcp_max_syn_backlog = 30000
net.ipv4.tcp_mtu_probing = 1
net.ipv4.tcp_fastopen = 3

${optimization_params}

net.ipv4.tcp_congestion_control = bbr
net.core.default_qdisc = fq
net.ipv4.tcp_slow_start_after_idle = 0
net.ipv4.tcp_no_metrics_save = 1
net.ipv4.tcp_window_scaling = 1
net.ipv4.tcp_timestamps = 1
net.ipv4.tcp_sack = 1
net.ipv4.tcp_dsack = 1

net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0

fs.file-max = 2097152
fs.nr_open = 2097152
fs.inotify.max_user_instances = 8192
fs.inotify.max_user_watches = 524288
fs.pipe-max-size = 1048576

vm.swappiness = 10
vm.min_free_kbytes = 65536
vm.overcommit_memory = 1
vm.max_map_count = 262144
EOF
    then
        OUT_ERROR "[é”™è¯¯] æ— æ³•å†™å…¥sysctlé…ç½®"
        return 1
    fi

    if [ -f /etc/security/limits.conf ] && \
       ! cp -f /etc/security/limits.conf "${BACKUP_DIR}/limits.conf.bak"; then
        OUT_ERROR "[é”™è¯¯] æ— æ³•å¤‡ä»½limits.conf"
        return 1
    fi
    
    if ! cat > /etc/security/limits.conf << 'EOF'
* soft nofile 2097152
* hard nofile 2097152
* soft nproc 2097152
* hard nproc 2097152
root soft nofile 2097152
root hard nofile 2097152
root soft nproc 2097152
root hard nproc 2097152
* soft memlock unlimited
* hard memlock unlimited
EOF
    then
        OUT_ERROR "[é”™è¯¯] æ— æ³•å†™å…¥limitsé…ç½®"
        return 1
    fi
    
    if [ -f /etc/pam.d/common-session ]; then
        if ! grep -q '^session.*pam_limits.so$' /etc/pam.d/common-session; then
            if ! echo "session required pam_limits.so" >> /etc/pam.d/common-session; then
                OUT_ERROR "[é”™è¯¯] æ— æ³•é…ç½®PAMåŠ è½½limits"
                return 1
            fi
        fi
    fi
    
    if ! sysctl -p; then
        OUT_ERROR "[é”™è¯¯] åº”ç”¨sysctlå‚æ•°å¤±è´¥"
        return 1
    fi
    
    OUT_SUCCESS "[æˆåŠŸ] ç³»ç»Ÿå‚æ•°ä¼˜åŒ–å®Œæˆ"
    return 0
}

main() { 
    OUT_INFO "[ä¿¡æ¯] å¼€å§‹ç³»ç»Ÿä¼˜åŒ–..."
    
    if ! mkdir -p "${BACKUP_DIR}"; then
        OUT_ERROR "[é”™è¯¯] æ— æ³•åˆ›å»ºå¤‡ä»½ç›®å½•"
        exit 1
    fi
    
    if ! check_root; then
        OUT_ERROR "[é”™è¯¯] Root æƒé™æ£€æŸ¥å¤±è´¥"
        exit 1
    fi
    
    if ! check_system; then
        OUT_ERROR "[é”™è¯¯] ç³»ç»Ÿæ£€æŸ¥å¤±è´¥"
        exit 1
    fi
    
    if ! install_requirements; then
        OUT_ERROR "[é”™è¯¯] å®‰è£…å¿…è¦å·¥å…·å¤±è´¥"
        exit 1
    fi
    
    if ! configure_dns; then
        OUT_ERROR "[é”™è¯¯] DNSé…ç½®å¤±è´¥"
        exit 1
    fi
    
    if ! configure_ntp; then
        OUT_ERROR "[é”™è¯¯] NTPé…ç½®å¤±è´¥"
        exit 1
    fi
    
    if ! optimize_system; then
        OUT_ERROR "[é”™è¯¯] ç³»ç»Ÿå‚æ•°ä¼˜åŒ–å¤±è´¥"
        exit 1
    fi
    
    OUT_SUCCESS "[æˆåŠŸ] ç³»ç»Ÿä¼˜åŒ–å®Œæˆï¼"
    OUT_INFO "[ä¿¡æ¯] å»ºè®®é‡å¯ç³»ç»Ÿä½¿æ‰€æœ‰ä¼˜åŒ–ç”Ÿæ•ˆ"
}
    ;;
# ä¸»æ‰§è¡Œé€»è¾‘
main() {
    
    if [[ "$1" == "install" ]]; then
        install_script
        exit 0
    fi

    if [ ! -d "$INSTALL_DIR" ]; then
        install_script
    else
        echo -e "${GREEN}è„šæœ¬å·²å®‰è£…åˆ°ï¼š$INSTALL_DIR${NC}"
    fi

    # è°ƒç”¨ä¸»èœå•
    while true; do
        show_main_menu
    done
}

# æ‰§è¡Œä¸»é€»è¾‘
main "$@"