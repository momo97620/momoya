#!/bin/bash

# 定义颜色
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
LIGHTCYAN='\033[1;36m'
NC='\033[0m' # No Color

# 自动安装脚本
auto_install() {
    # 目标脚本路径
    TARGET_SCRIPT=/root/vps666

    # 检查 /root/vps666 文件是否存在
    if [ -f "$TARGET_SCRIPT" ]; then
        echo -e "${GREEN}/root/vps666 文件存在，正在设置快捷指令 'm'...${NC}"
    else
        echo -e "${RED}/root/vps666 文件不存在，请确保文件已下载到该路径。${NC}"
        exit 1
    fi

    # 检查 ~/.bashrc 文件
    if [ ! -f ~/.bashrc ]; then
        echo -e "${RED}警告：~/.bashrc 文件不存在，正在创建...${NC}"
        touch ~/.bashrc
        chmod 644 ~/.bashrc  # 确保文件可写
    fi

    if [ ! -w ~/.bashrc ]; then
        echo -e "${RED}错误：~/.bashrc 文件不可写，请检查文件权限。${NC}"
        exit 1
    fi

    # 检查是否已存在别名
    if grep -q "alias m='sudo /root/vps666'" ~/.bashrc; then
        echo -e "${YELLOW}快捷命令 'm' 已存在，无需重复添加${NC}"
    else
        echo "alias m='sudo /root/vps666'" >> ~/.bashrc
        echo -e "${GREEN}已将快捷命令 'm' 添加到 ~/.bashrc${NC}"
    fi

    # 确保别名立即生效
    if [ -n "$BASH_VERSION" ]; then
        source ~/.bashrc
        echo -e "${GREEN}.bashrc 已重新加载，别名 'm' 已生效。${NC}"
    else
        echo -e "${YELLOW}提示：当前 shell 不是 bash，请手动执行 source ~/.bashrc 以生效。${NC}"
    fi

    echo -e "${LIGHTCYAN}安装完成！现在你可以使用 'm' 命令直接启动脚本。${NC}"

    # 调试信息
    echo -e "${YELLOW}当前用户: $(whoami)${NC}"
    echo -e "${YELLOW}~/.bashrc 文件权限: $(ls -l ~/.bashrc)${NC}"
    echo -e "${YELLOW}~/.bashrc 内容: $(cat ~/.bashrc)${NC}"
}

# 获取脚本路径
SCRIPT_PATH=$(realpath "${BASH_SOURCE[0]}")
SCRIPT_DIR=$(dirname "$SCRIPT_PATH")

# 检查脚本是否被直接运行
if [[ "${BASH_SOURCE[0]}" != "${0}" ]]; then
    echo -e "${RED}此脚本必须直接运行，而不是被源化。${NC}"
    exit 1
fi

# 检查是否以 root 用户运行
if [ "$(id -u)" != "0" ]; then
    echo -e "${RED}请以 root 用户运行脚本。${NC}"
    exit 1
fi

# 执行自动安装
auto_install
