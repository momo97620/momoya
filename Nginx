#!/bin/bash

LIGHTCYAN='\033[1;36m'
NC='\033[0m' # No Color

# 清屏
clear

# 日志文件
LOGFILE="/var/log/reverse_proxy_setup.log"

# 记录日志的函数
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOGFILE"
}

# 动态获取操作系统
detect_os() {
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        OS=$ID
        VERSION_ID=$VERSION_ID
    else
        echo "无法检测操作系统类型。请确认系统是否兼容。"
        exit 1
    fi
}

# 检查软件包是否已安装
check_installed() {
    which nginx &>/dev/null && which certbot &>/dev/null
}

# 安装必要的软件包
install_packages() {
    case $OS in
        debian | ubuntu)
            sudo apt update || { echo "更新失败"; exit 1; }
            sudo apt install -y nginx certbot python3-certbot-nginx curl || { echo "安装失败"; exit 1; }
            ;;
        centos | rocky | almalinux)
            sudo yum install -y epel-release || { echo "安装 EPEL 失败"; exit 1; }
            sudo yum install -y nginx certbot python3-certbot-nginx curl || { echo "安装失败"; exit 1; }
            ;;
        *)
            echo "暂不支持的操作系统: $OS"
            exit 1
            ;;
    esac
    log "必要软件包安装完成。"
}

# 修复 Certbot 路径
fix_certbot_path() {
    if ! which certbot &>/dev/null; then
        echo "Certbot 未找到，尝试修复路径..."
        if [ -d "/usr/local/bin" ]; then
            sudo ln -s /usr/bin/certbot /usr/local/bin/certbot
            echo "已修复 Certbot 路径到 /usr/local/bin/"
        else
            echo "无法找到适当的路径修复 Certbot。"
            exit 1
        fi
    fi
}

# 创建验证路径并更新配置
setup_validation_path() {
    sudo mkdir -p /var/www/html/.well-known/acme-challenge
    sudo chmod -R 755 /var/www/html/.well-known

    nginx_conf="/etc/nginx/sites-available/default"
    if [ -f "$nginx_conf" ]; then
        # 检查是否已经存在 .well-known 的 location 块
        if ! grep -q ".well-known/acme-challenge" "$nginx_conf"; then
            # 确保 server 块存在
            if ! grep -q "server {" "$nginx_conf"; then
                echo "未找到 server 块，正在创建..."
                sudo tee -a "$nginx_conf" <<EOF
server {
    listen 80;
    server_name _;

    location / {
        root /var/www/html;
        index index.html;
    }
}
EOF
            fi

            # 在 server 块中添加 location 块
            sudo sed -i '/server_name/a \ \ \ \ location ^~ /.well-known/acme-challenge/ {\n\ \ \ \ \ \ \ \ root /var/www/html;\n\ \ \ \ \ \ \ \ default_type "text/plain";\n\ \ \ \ }\n' "$nginx_conf"
            log "验证路径已添加到 Nginx 配置: $nginx_conf"
        else
            log "验证路径已存在于 Nginx 配置中，无需重复添加。"
        fi
    else
        echo "默认 Nginx 配置文件缺失，无法添加验证路径。"
        exit 1
    fi

    # 测试 Nginx 配置并重启
    if sudo nginx -t; then
        sudo systemctl reload nginx
        log "Nginx 配置已重启以应用验证路径。"
    else
        echo "Nginx 配置测试失败，检查配置文件。"
        exit 1
    fi
}

# 获取证书到期时间
get_cert_expiry() {
    cert_info=$(sudo certbot certificates 2>/dev/null)
    if [[ $? -eq 0 && $cert_info ]]; then
        echo "当前证书列表："
        echo "$cert_info" | awk '/Certificate Name:|Expiry Date/ {print}'
    else
        echo "没有找到有效的 SSL/TLS 证书。"
    fi
}

# 删除证书
delete_certificate() {
    echo "删除证书..."
    read -e -p "请输入要删除的域名: " domain_to_delete
    if sudo certbot delete --cert-name "$domain_to_delete"; then
        echo "证书删除成功: $domain_to_delete"
        log "删除证书: $domain_to_delete"
    else
        echo "未能成功删除证书，检查域名拼写是否正确。"
    fi
    read -p "按任意键返回主菜单..." 
}

# 删除反向代理配置
delete_reverse_proxy() {
    echo "删除反向代理配置..."
    read -e -p "请输入要删除的域名: " domain_to_delete
    if [ -f "/etc/nginx/sites-available/$domain_to_delete.conf" ]; then
        sudo rm "/etc/nginx/sites-available/$domain_to_delete.conf"
        sudo rm "/etc/nginx/sites-enabled/$domain_to_delete.conf"
        sudo nginx -t && sudo systemctl reload nginx
        echo "反向代理配置已删除: $domain_to_delete"
        log "删除反向代理配置: $domain_to_delete"
    else
        echo "未找到配置文件: $domain_to_delete"
    fi
}

# 检查 Nginx 状态
check_nginx_status() {
    if systemctl is-active --quiet nginx; then
        echo "Nginx 状态: 运行中"
    else
        echo "Nginx 状态: 未安装或未运行"
    fi
}

# 配置反向代理并申请证书
configure_reverse_proxy_and_ssl() {
    echo "配置反向代理并申请 SSL/TLS 证书..."
    read -e -p "请输入你的域名: " yuming
    if [[ ! "$yuming" =~ ^[a-zA-Z0-9.-]+$ ]]; then
        echo "无效的域名格式。"
        exit 1
    fi

    read -e -p "请输入你的反代 IP 或 IPv6 地址 (默认: 127.0.0.1): " reverseproxy
    reverseproxy="${reverseproxy:-127.0.0.1}"
    [[ "$reverseproxy" =~ : && "$reverseproxy" != \[*\] ]] && reverseproxy="[$reverseproxy]"

    read -e -p "请输入你的反代端口 (默认: 80): " port
    port="${port:-80}"

    read -p "请输入用于 Certbot 注册的电子邮件地址: " user_email
    if [[ ! "$user_email" =~ ^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$ ]]; then
        echo "无效的电子邮件地址。"
        exit 1
    fi

    # 创建 Nginx 配置文件
    nginx_conf="/etc/nginx/sites-available/$yuming.conf"
    sudo tee "$nginx_conf" <<EOF
server {
    listen 80;
    server_name $yuming;

    location / {
        proxy_pass http://$reverseproxy:$port;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }

    location ^~ /.well-known/acme-challenge/ {
        root /var/www/html;
        default_type "text/plain";
    }
}
EOF

    # 启用配置文件
    sudo ln -sf "$nginx_conf" "/etc/nginx/sites-enabled/$yuming.conf"

    # 测试并重启 Nginx
    if sudo nginx -t; then
        sudo systemctl reload nginx
        echo "Nginx 配置已生效。"
        log "Nginx 配置已成功应用。"
    else
        echo "Nginx 配置有误，无法生效。"
        exit 1
    fi

    # 申请 SSL 证书
    if sudo certbot certonly --webroot -w /var/www/html -d "$yuming" --non-interactive --agree-tos --email "$user_email"; then
        echo "SSL/TLS 证书申请成功。"
        log "SSL/TLS 证书申请成功: $yuming"

        # 添加 HTTPS 配置到 Nginx 配置文件
        sudo tee -a "$nginx_conf" <<EOF
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name $yuming;

    ssl_certificate /etc/letsencrypt/live/$yuming/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/$yuming/privkey.pem;

    location / {
        proxy_pass http://$reverseproxy:$port;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }
}
EOF

        # 重启 Nginx
        if sudo nginx -t; then
            sudo systemctl reload nginx
            log "HTTPS 配置已应用到 Nginx 配置文件。"
        else
            echo "Nginx 配置测试失败，请检查配置文件。"
            exit 1
        fi
    else
        echo "证书申请失败，请检查域名和网络配置。"
        exit 1
    fi
    read -p "按任意键返回主菜单..."
}

# 主菜单显示
show_menu() {
    clear
    check_nginx_status
    echo ""
    get_cert_expiry
    echo ""
    echo "=========================================="
    echo "请选择操作："
    echo "1. 配置反向代理并申请 SSL 证书"
    echo "2. 查询已配置的反向代理域名或 IP"
    echo "3. 查询已申请的证书"
    echo "4. 删除反向代理配置"
    echo "5. 删除证书"
    echo "0. 退出"
    echo "=========================================="
}

# 主循环
if [ ! -f /etc/reverse_proxy_setup_done ]; then
    detect_os
    if ! check_installed; then
        install_packages
    fi
    fix_certbot_path
    setup_validation_path
    sudo touch /etc/reverse_proxy_setup_done
    echo "首次安装已完成，跳过后续安装步骤。"
fi

while true; do
    show_menu
    read -p "请输入操作编号 (0-5): " choice
    case $choice in
        1) configure_reverse_proxy_and_ssl ;;
        2) ls /etc/nginx/sites-available/; read -p "按任意键返回主菜单..." ;;
        3) sudo certbot certificates; read -p "按任意键返回主菜单..." ;;
        4) delete_reverse_proxy; read -p "按任意键返回主菜单..." ;;
        5) delete_certificate ;;
        0) 
            echo -e "${LIGHTCYAN}此项目只对Debian系统生效，如果不是Debian系统请退出！！。${NC}"
            exit 0 ;;
        *) echo "无效的选择，请重新输入。" ;;
    esac
done