#!/bin/bash

# 日志记录
LOGFILE="/var/log/reverse_proxy_setup.log"
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOGFILE"
}

# 清屏
clear

# 动态检测操作系统
detect_os() {
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        OS=$ID
        VERSION_ID=$VERSION_ID
    else
        echo "无法检测操作系统类型。请确认系统是否兼容。"
        exit 1
    fi
}

# 安装必要的软件包
install_packages() {
    case $OS in
        debian | ubuntu)
            sudo apt update
            sudo apt install -y nginx certbot python3-certbot-nginx curl || {
                echo "软件包安装失败，请检查网络或源配置。"
                exit 1
            }
            ;;
        centos | rocky | almalinux)
            sudo yum install -y epel-release
            sudo yum install -y nginx certbot python3-certbot-nginx curl || {
                echo "软件包安装失败，请检查网络或源配置。"
                exit 1
            }
            ;;
        *)
            echo "暂不支持的操作系统: $OS"
            exit 1
            ;;
    esac

    # 验证安装结果
    if ! which nginx &>/dev/null; then
        echo "Nginx 安装失败。"
        exit 1
    fi
    if ! which certbot &>/dev/null; then
        echo "Certbot 安装失败。"
        exit 1
    fi

    ensure_permissions
    log "必要软件包安装完成。"
}

# 修复 Certbot 路径问题
fix_certbot_path() {
    if ! which certbot &>/dev/null; then
        echo "Certbot 未找到，尝试修复路径..."
        if [ -d "/usr/local/bin" ]; then
            sudo ln -s /usr/bin/certbot /usr/local/bin/certbot
            echo "已修复 Certbot 路径到 /usr/local/bin/"
        else
            echo "无法找到适当的路径修复 Certbot。"
            exit 1
        fi
    fi
}

# 确保权限正确
ensure_permissions() {
    sudo mkdir -p /etc/nginx/sites-available /etc/nginx/sites-enabled /var/www/html
    sudo chmod -R 755 /etc/nginx /var/www/html
    sudo chown -R www-data:www-data /var/www/html
    log "权限已正确赋予：/etc/nginx 和 /var/www/html"
}

# 配置验证路径和 Nginx 配置
setup_validation_path() {
    local domain="$1"
    local nginx_conf="/etc/nginx/sites-available/$domain.conf"

    # 提前创建验证路径
    sudo mkdir -p /var/www/html/.well-known/acme-challenge
    sudo chmod -R 755 /var/www/html/.well-known

    # 确保验证路径配置在 Nginx 文件中
    if [ -f "$nginx_conf" ]; then
        if ! grep -q ".well-known/acme-challenge" "$nginx_conf"; then
            sudo sed -i "/server_name/a \ \ \ \ location ^~ /.well-known/acme-challenge/ {\n\ \ \ \ \ \ \ \ root /var/www/html;\n\ \ \ \ \ \ \ \ default_type \"text/plain\";\n\ \ \ \ }\n" "$nginx_conf"
            log "验证路径已添加到 Nginx 配置: $nginx_conf"
        fi
    else
        echo "未找到 Nginx 配置文件: $nginx_conf"
        exit 1
    fi

    # 测试并重载 Nginx 配置
    if sudo nginx -t; then
        sudo systemctl reload nginx
        log "Nginx 配置已重新加载。"
    else
        echo "Nginx 配置测试失败，请检查配置文件。"
        exit 1
    fi
}

# 申请证书
request_certificate() {
    local domain="$1"
    local email="$2"

    if sudo certbot certonly --webroot -w /var/www/html -d "$domain" --non-interactive --agree-tos --email "$email"; then
        echo "SSL/TLS 证书申请成功: $domain"
        log "SSL/TLS 证书申请成功: $domain"
    else
        echo "证书申请失败，请检查域名或网络配置。"
        exit 1
    fi
    read -p "按任意键返回上一页..." temp
}

# 配置反向代理并申请 SSL
configure_reverse_proxy_and_ssl() {
    # 确保必要组件已安装
    detect_os
    install_packages
    fix_certbot_path

    # 输入域名
    read -e -p "请输入你的域名: " domain
    if [[ ! "$domain" =~ ^[a-zA-Z0-9.-]+$ ]]; then
        echo "无效的域名格式。"
        exit 1
    fi

    # 输入反向代理地址
    read -e -p "请输入你的反代 IP 或 IPv6 地址 (默认: 127.0.0.1): " reverseproxy
    reverseproxy="${reverseproxy:-127.0.0.1}"
    [[ "$reverseproxy" =~ : && "$reverseproxy" != \[*\] ]] && reverseproxy="[$reverseproxy]"

    # 输入端口
    read -e -p "请输入你的反代端口 (默认: 80): " port
    port="${port:-80}"

    # 输入邮箱
    read -p "请输入用于 Certbot 注册的电子邮件地址: " user_email
    if [[ ! "$user_email" =~ ^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$ ]]; then
        echo "无效的电子邮件地址。"
        exit 1
    fi

    # 配置 Nginx 文件
    local nginx_conf="/etc/nginx/sites-available/$domain.conf"
    sudo tee "$nginx_conf" >/dev/null <<EOF
server {
    listen 80;
    server_name $domain;

    location / {
        proxy_pass http://$reverseproxy:$port;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }
}
EOF

    # 启用配置
    sudo ln -sf "$nginx_conf" "/etc/nginx/sites-enabled/$domain.conf"
    ensure_permissions

    # 测试 Nginx 配置
    if sudo nginx -t; then
        sudo systemctl reload nginx
        echo "Nginx 配置已生效。"
        log "Nginx 配置已成功应用。"
    else
        echo "Nginx 配置有误，无法生效。"
        exit 1
    fi

    # 设置验证路径
    setup_validation_path "$domain"

    # 申请证书
    request_certificate "$domain" "$user_email"

    read -p "按任意键返回上一页..." temp
}

# 主菜单
while true; do
    clear
    echo "=========================================="
    echo "请选择操作："
    echo "1. 配置反向代理并申请 SSL 证书"
    echo "2. 查询已配置的反向代理"
    echo "3. 查询已申请的证书"
    echo "4. 删除反向代理配置"
    echo "0. 退出"
    echo "=========================================="
    read -p "请输入操作编号 (0-4): " choice
    case $choice in
        1) configure_reverse_proxy_and_ssl ;;
        2) 
            ls /etc/nginx/sites-available/
            read -p "按任意键返回上一页..." temp
            ;;
        3) 
            sudo certbot certificates
            read -p "按任意键返回上一页..." temp
            ;;
        4) 
            read -p "请输入要删除的域名: " domain_to_delete
            sudo rm -f "/etc/nginx/sites-available/$domain_to_delete.conf"
            sudo rm -f "/etc/nginx/sites-enabled/$domain_to_delete.conf"
            sudo systemctl reload nginx
            echo "已删除反向代理配置: $domain_to_delete"
            read -p "按任意键返回上一页..." temp
            ;;
        0) exit 0 ;;
        *) echo "无效的选择，请重新输入。" ;;
    esac
done