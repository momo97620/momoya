#!/bin/bash

# 定义变量
BACKUP_DIR="/root/backup"      # 本地备份目录
ONEDRIVE_DIR="/root/onedrive" # 本地OneDrive同步目录
MAX_BACKUPS=3                 # 最大保留备份数量
TIMESTAMP=$(date +"%Y%m%d%H%M%S")
BACKUP_FILE="backup_$TIMESTAMP.tar.gz"
DOCKER_BACKUP_FILE="docker_backup_$TIMESTAMP.tar.gz"

# 创建备份目录
mkdir -p "$BACKUP_DIR"
mkdir -p "$ONEDRIVE_DIR"

# 检查并安装OneDrive同步工具
install_onedrive() {
    if ! command -v onedrive &>/dev/null; then
        echo "未检测到 OneDrive 同步工具，开始安装..."
        apt update && apt install -y onedrive
        echo "OneDrive 同步工具安装完成。"
        echo "初始化 OneDrive 同步工具配置..."
        onedrive --synchronize || onedrive --initialize
        echo "请根据提示完成 OneDrive 账户授权并同步。"
    else
        echo "OneDrive 同步工具已安装。"
    fi
}

# 启动OneDrive同步
start_onedrive_sync() {
    echo "启动 OneDrive 同步服务..."
    systemctl --user enable onedrive
    systemctl --user start onedrive
    echo "OneDrive 同步服务已启动。"
}

# 普通数据备份
backup_system() {
    echo "开始备份系统数据..."
    tar -czf "$BACKUP_DIR/$BACKUP_FILE" /etc /home /var/log 2>/dev/null
    echo "系统数据备份完成: $BACKUP_FILE"
}

# Docker 备份
backup_docker() {
    echo "开始备份 Docker 数据..."
    # 导出所有容器
    mkdir -p "$BACKUP_DIR/docker_containers"
    for container in $(docker ps -q); do
        docker export "$container" > "$BACKUP_DIR/docker_containers/${container}_backup.tar"
        echo "容器已备份: $container"
    done

    # 导出所有镜像
    docker save $(docker images -q) -o "$BACKUP_DIR/docker_images.tar"
    echo "Docker 镜像已备份。"

    # 打包 Docker 备份
    tar -czf "$BACKUP_DIR/$DOCKER_BACKUP_FILE" -C "$BACKUP_DIR" docker_containers docker_images.tar
    echo "Docker 数据备份完成: $DOCKER_BACKUP_FILE"

    # 清理中间文件
    rm -rf "$BACKUP_DIR/docker_containers" "$BACKUP_DIR/docker_images.tar"
}

# 上传备份到OneDrive
upload_to_onedrive() {
    echo "上传备份到 OneDrive..."
    cp "$BACKUP_DIR/$BACKUP_FILE" "$ONEDRIVE_DIR/"
    cp "$BACKUP_DIR/$DOCKER_BACKUP_FILE" "$ONEDRIVE_DIR/"

    # 限制备份数量
    echo "检查并限制OneDrive备份文件数量..."
    while [ $(ls "$ONEDRIVE_DIR"/backup_*.tar.gz 2>/dev/null | wc -l) -gt $MAX_BACKUPS ]; do
        OLDEST_FILE=$(ls "$ONEDRIVE_DIR"/backup_*.tar.gz | head -n 1)
        rm -f "$OLDEST_FILE"
        echo "已删除旧备份: $OLDEST_FILE"
    done
    while [ $(ls "$ONEDRIVE_DIR"/docker_backup_*.tar.gz 2>/dev/null | wc -l) -gt $MAX_BACKUPS ]; do
        OLDEST_DOCKER_FILE=$(ls "$ONEDRIVE_DIR"/docker_backup_*.tar.gz | head -n 1)
        rm -f "$OLDEST_DOCKER_FILE"
        echo "已删除旧 Docker 备份: $OLDEST_DOCKER_FILE"
    done

    onedrive --synchronize
    echo "备份上传完成。"
}

# 菜单界面
menu() {
    while true; do
        clear
        echo "====================="
        echo "  VPS 备份管理工具"
        echo "====================="
        echo "1. 备份系统数据"
        echo "2. 备份 Docker 数据"
        echo "3. 查看备份文件"
        echo "4. 配置 OneDrive"
        echo "0. 退出"
        echo "====================="
        read -p "请输入选项: " choice
        case $choice in
            1)
                backup_system
                upload_to_onedrive
                read -p "按任意键返回菜单..."
                ;;
            2)
                backup_docker
                upload_to_onedrive
                read -p "按任意键返回菜单..."
                ;;
            3)
                echo "本地备份文件："
                ls -lh "$BACKUP_DIR" | grep "backup_"
                echo "OneDrive备份文件："
                ls -lh "$ONEDRIVE_DIR" | grep "backup_"
                read -p "按任意键返回菜单..."
                ;;
            4)
                install_onedrive
                start_onedrive_sync
                read -p "按任意键返回菜单..."
                ;;
            0)
                echo "退出工具。"
                break
                ;;
            *)
                echo "无效选项，请重新输入。"
                sleep 2
                ;;
        esac
    done
}

# 主程序入口
menu