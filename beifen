#!/bin/bash

# 定义变量
BACKUP_DIR="/root/backup"      # 本地备份目录
ONEDRIVE_DIR="/root/onedrive" # 本地 OneDrive 同步目录
MAX_BACKUPS=3                 # 最大保留备份数量
TIMESTAMP=$(date +"%Y%m%d%H%M%S")
BACKUP_FILE="backup_$TIMESTAMP.tar.gz"
DOCKER_BACKUP_FILE="docker_backup_$TIMESTAMP.tar.gz"

# 创建备份目录
mkdir -p "$BACKUP_DIR"
mkdir -p "$ONEDRIVE_DIR"

# 检测并安装 OneDrive 工具
install_or_update_onedrive() {
    echo "检测 OneDrive 同步工具..."
    if ! command -v onedrive &>/dev/null; then
        echo "未检测到 OneDrive 工具，开始安装..."
        install_latest_onedrive
    else
        CURRENT_VERSION=$(onedrive --version | awk '{print $3}')
        echo "已安装 OneDrive 版本: $CURRENT_VERSION"
        LATEST_VERSION=$(curl -s https://api.github.com/repos/abraunegg/onedrive/releases/latest | grep '"tag_name":' | sed -E 's/.*"v([^"]+)".*/\1/')
        if [ "$CURRENT_VERSION" != "$LATEST_VERSION" ]; then
            echo "检测到新版本 ($LATEST_VERSION)，正在更新..."
            install_latest_onedrive
        else
            echo "OneDrive 已是最新版本 ($CURRENT_VERSION)，跳过安装。"
        fi
    fi
}

install_latest_onedrive() {
    echo "安装或更新 OneDrive 工具..."
    DEPENDENCIES=("curl" "wget" "build-essential" "libcurl4-openssl-dev" "libsqlite3-dev")
    echo "检查并安装依赖项: ${DEPENDENCIES[*]}"
    for pkg in "${DEPENDENCIES[@]}"; do
        if ! dpkg -l | grep -qw "$pkg"; then
            apt-get install -y "$pkg" || {
                echo "安装依赖 $pkg 失败，请手动检查！"
                exit 1
            }
        fi
    done

    LATEST_VERSION=$(curl -s https://api.github.com/repos/abraunegg/onedrive/releases/latest | grep '"tag_name":' | sed -E 's/.*"v([^"]+)".*/\1/')
    echo "下载 OneDrive 二进制文件，版本: $LATEST_VERSION"
    wget -q "https://github.com/abraunegg/onedrive/releases/download/v$LATEST_VERSION/onedrive.x86_64" -O /usr/local/bin/onedrive || {
        echo "下载失败，请检查网络连接或 GitHub URL！"
        exit 1
    }

    echo "赋予执行权限..."
    chmod +x /usr/local/bin/onedrive

    # 验证安装成功
    if ! command -v onedrive &>/dev/null; then
        echo "OneDrive 安装失败，请手动检查。"
        exit 1
    fi

    echo "OneDrive 工具安装完成，版本: $(onedrive --version)"
}

# 执行 OneDrive 认证
configure_onedrive() {
    echo "配置 OneDrive 账户授权..."
    if [ ! -f ~/.config/onedrive/refresh_token ]; then
        onedrive --authenticate
        if [ $? -ne 0 ]; then
            echo "OneDrive 授权失败，请检查网络或账户信息。"
            exit 1
        fi
    else
        echo "已检测到 OneDrive 授权，无需重复配置。"
    fi
}

# 启动 OneDrive 同步服务
start_onedrive_sync() {
    echo "启动 OneDrive 同步服务..."
    systemctl --user enable onedrive
    export XDG_RUNTIME_DIR=/run/user/$(id -u)
    systemctl --user start onedrive
    echo "OneDrive 同步服务已启动。"
}

# 备份系统数据
backup_system() {
    echo "开始备份系统数据..."
    tar -czf "$BACKUP_DIR/$BACKUP_FILE" /etc /home /var/log 2>/dev/null
    echo "系统数据备份完成: $BACKUP_FILE"
}

# 备份 Docker 数据
backup_docker() {
    echo "开始备份 Docker 数据..."
    mkdir -p "$BACKUP_DIR/docker_containers"
    for container in $(docker ps -q); do
        docker export "$container" > "$BACKUP_DIR/docker_containers/${container}_backup.tar"
        echo "容器已备份: $container"
    done
    docker save $(docker images -q) -o "$BACKUP_DIR/docker_images.tar"
    echo "Docker 镜像已备份。"
    tar -czf "$BACKUP_DIR/$DOCKER_BACKUP_FILE" -C "$BACKUP_DIR" docker_containers docker_images.tar
    echo "Docker 数据备份完成: $DOCKER_BACKUP_FILE"
    rm -rf "$BACKUP_DIR/docker_containers" "$BACKUP_DIR/docker_images.tar"
}

# 上传备份到 OneDrive
upload_to_onedrive() {
    echo "上传备份到 OneDrive..."
    cp "$BACKUP_DIR/$BACKUP_FILE" "$ONEDRIVE_DIR/"
    cp "$BACKUP_DIR/$DOCKER_BACKUP_FILE" "$ONEDRIVE_DIR/"
    echo "检查并限制 OneDrive 备份文件数量..."
    while [ $(ls "$ONEDRIVE_DIR"/backup_*.tar.gz 2>/dev/null | wc -l) -gt $MAX_BACKUPS ]; do
        OLDEST_FILE=$(ls "$ONEDRIVE_DIR"/backup_*.tar.gz | head -n 1)
        rm -f "$OLDEST_FILE"
        echo "已删除旧备份: $OLDEST_FILE"
    done
    while [ $(ls "$ONEDRIVE_DIR"/docker_backup_*.tar.gz 2>/dev/null | wc -l) -gt $MAX_BACKUPS ]; do
        OLDEST_DOCKER_FILE=$(ls "$ONEDRIVE_DIR"/docker_backup_*.tar.gz | head -n 1)
        rm -f "$OLDEST_DOCKER_FILE"
        echo "已删除旧 Docker 备份: $OLDEST_DOCKER_FILE"
    done
    onedrive --synchronize
    echo "备份上传完成。"
}

# 菜单界面
menu() {
    while true; do
        clear
        echo "====================="
        echo "  VPS 备份管理工具"
        echo "====================="
        echo "1. 备份系统数据"
        echo "2. 备份 Docker 数据"
        echo "3. 查看备份文件"
        echo "4. 配置 OneDrive"
        echo "0. 退出"
        echo "====================="
        read -p "请输入选项: " choice
        case $choice in
            1)
                backup_system
                upload_to_onedrive
                read -p "按任意键返回菜单..."
                ;;
            2)
                backup_docker
                upload_to_onedrive
                read -p "按任意键返回菜单..."
                ;;
            3)
                echo "本地备份文件："
                ls -lh "$BACKUP_DIR" | grep "backup_"
                echo "OneDrive备份文件："
                ls -lh "$ONEDRIVE_DIR" | grep "backup_"
                read -p "按任意键返回菜单..."
                ;;
            4)
                install_or_update_onedrive
                configure_onedrive
                start_onedrive_sync
                read -p "按任意键返回菜单..."
                ;;
            0)
                echo "退出工具。"
                break
                ;;
            *)
                echo "无效选项，请重新输入。"
                sleep 2
                ;;
        esac
    done
}

# 主程序入口
install_or_update_onedrive
menu