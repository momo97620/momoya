#!/bin/bash

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # 恢复默认颜色

# 获取系统基本信息
get_system_info() {
    # 主机名
    local HOSTNAME=$(hostname)
    
    # 操作系统信息
    local OS_INFO=$(grep PRETTY_NAME /etc/os-release | cut -d '=' -f2 | tr -d '"')
    
    # 内核版本
    local KERNEL_VERSION=$(uname -r)
    
    # CPU信息
    local CPU_INFO=$(lscpu | awk -F': +' '/Model name:/ {print $2; exit}')
    local CPU_CORES=$(nproc)
    local CPU_ARCH=$(uname -m)
    
    # 内存信息
    local MEM_INFO=$(free -h | awk 'NR==2{printf "%s/%s (%.1f%%)", $3, $2, $3/$2*100}')
    
    # 硬盘信息
    local DISK_INFO=$(df -h | awk '$NF=="/" {printf "%s/%s (%s)", $3, $2, $5}')
    
    echo "$HOSTNAME|$OS_INFO|$KERNEL_VERSION|$CPU_INFO|$CPU_CORES|$CPU_ARCH|$MEM_INFO|$DISK_INFO"
}

# 获取地理位置信息
get_location() {
    local ipinfo=$(curl -s ipinfo.io)
    local country=$(echo "$ipinfo" | grep 'country' | awk -F': ' '{print $2}' | tr -d '",')
    local city=$(echo "$ipinfo" | grep 'city' | awk -F': ' '{print $2}' | tr -d '",')
    local isp=$(echo "$ipinfo" | grep 'org' | awk -F': ' '{print $2}' | tr -d '",')
    
    if [ -n "$country" ] && [ -n "$city" ]; then
        echo "$country $city|$isp"
    else
        echo "未知位置|未知运营商"
    fi
}

# 获取网络流量
get_network_traffic() {
    # 获取网络接口
    local interface=$(ip route | grep default | awk '{print $5}' | head -n1)
    
    # 从 /proc/net/dev 获取流量信息
    local rx_bytes=$(awk -v interface="$interface" '$1 == interface":" {print $2}' /proc/net/dev)
    local tx_bytes=$(awk -v interface="$interface" '$1 == interface":" {print $10}' /proc/net/dev)
    
    # 转换为 GB
    local rx_gb=$(echo "scale=2; $rx_bytes / 1024 / 1024 / 1024" | bc)
    local tx_gb=$(echo "scale=2; $tx_bytes / 1024 / 1024 / 1024" | bc)
    
    echo "${rx_gb:-0.00}|${tx_gb:-0.00}"
}

# 获取网络信息
get_network_info() {
    local ipv4=$(curl -s4 https://ipinfo.io/ip)
    local ipv6=$(ip -6 addr show | grep inet6 | grep -v '::1' | grep -v 'fe80' | awk '{print $2}' | cut -d'/' -f1 | head -n1)
    
    echo "${ipv4:-未分配}|${ipv6:-未分配}"
}

# 主程序
main() {
    clear
    echo -e "${GREEN}系统信息收集与分析${NC}"
    echo -e "${RED}--------------------${NC}"

    # 获取系统信息
    IFS='|' read -r HOSTNAME OS_INFO KERNEL_VERSION CPU_INFO CPU_CORES CPU_ARCH MEM_INFO DISK_INFO <<< "$(get_system_info)"

    # 获取网络和位置信息
    IFS='|' read -r LOCATION ISP <<< "$(get_location)"
    IFS='|' read -r IPV4 IPV6 <<< "$(get_network_info)"
    IFS='|' read -r RX_BYTES TX_BYTES <<< "$(get_network_traffic)"

    # 当前时间和时区
    local CURRENT_TIME=$(date "+%Y-%m-%d %H:%M:%S")
    local TIMEZONE=$(timedatectl | grep "Time zone" | awk '{print $3}')

    # 系统运行时间
    local RUNTIME=$(uptime -p)

    # 输出系统信息
    echo -e "${GREEN}系统基本信息:${NC}"
    echo -e "主机名:       ${YELLOW}$HOSTNAME${NC}"
    echo -e "操作系统:     ${YELLOW}$OS_INFO${NC}"
    echo -e "内核版本:     ${YELLOW}$KERNEL_VERSION${NC}"
    echo -e "${RED}--------------------${NC}"

    echo -e "${GREEN}硬件信息:${NC}"
    echo -e "CPU型号:      ${YELLOW}$CPU_INFO${NC}"
    echo -e "CPU核心数:    ${YELLOW}$CPU_CORES${NC}"
    echo -e "CPU架构:      ${YELLOW}$CPU_ARCH${NC}"
    echo -e "内存:         ${YELLOW}$MEM_INFO${NC}"
    echo -e "硬盘:         ${YELLOW}$DISK_INFO${NC}"
    echo -e "${RED}--------------------${NC}"

    echo -e "${GREEN}网络信息:${NC}"
    echo -e "运营商:       ${YELLOW}$ISP${NC}"
    echo -e "地理位置:     ${YELLOW}$LOCATION${NC}"
    echo -e "IPv4地址:     ${YELLOW}$IPV4${NC}"
    echo -e "IPv6地址:     ${YELLOW}$IPV6${NC}"
    echo -e "网络流量:     ${YELLOW}下行: ${RX_BYTES}GB 上行: ${TX_BYTES}GB${NC}"
    echo -e "${RED}--------------------${NC}"

    echo -e "${GREEN}系统时间:${NC}"
    echo -e "时区:         ${YELLOW}$TIMEZONE${NC}"
    echo -e "当前时间:     ${YELLOW}$CURRENT_TIME${NC}"
    echo -e "运行时间:     ${YELLOW}$RUNTIME${NC}"
    echo -e "${RED}--------------------${NC}"

    echo -e "\n${GREEN}操作完成${NC}"
    echo -e "${BLUE}按任意键继续...${NC}"
    
    # 等待用户按键
    read -n 1 -s
}

# 调用主程序
main
